<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½è¨ˆç¨‹è»Šå»£å‘Šç®¡ç†ç³»çµ±</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f5f7fa;
            color: #333;
        }

        /* é ‚éƒ¨å°èˆªæ¬„ */
        .navbar {
            background-color: #2c3e50;
            color: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
        }

        .navbar h1 {
            font-size: 1.5rem;
            font-weight: 500;
        }

        .navbar-actions {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 0.95rem;
        }

        .navbar-actions span {
            color: #ecf0f1;
            font-weight: 500;
        }

        /* ä¸»è¦å®¹å™¨ */
        .container {
            display: flex;
            min-height: calc(100vh - 60px);
        }

        /* å´é‚Šæ¬„ */
        .sidebar {
            width: 250px;
            background-color: #34495e;
            padding: 1rem 0;
        }

        .sidebar-item {
            padding: 1rem 1.5rem;
            color: #ecf0f1;
            cursor: pointer;
            transition: background-color 0.3s;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            font-size: 1rem;
        }

        .sidebar-item:hover {
            background-color: #2c3e50;
        }

        .sidebar-item.active {
            background-color: #3498db;
        }

        .sidebar-item i {
            margin-right: 0.5rem;
            width: 20px;
            display: inline-block;
        }

        /* ä¸»å…§å®¹å€ */
        .main-content {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
        }

        /* å¡ç‰‡æ¨£å¼ */
        .card {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 1.5rem;
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: #2c3e50;
        }

        /* çµ±è¨ˆå¡ç‰‡ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #3498db;
        }

        .stat-label {
            color: #7f8c8d;
            margin-top: 0.5rem;
        }

        /* è¡¨æ ¼æ¨£å¼ */
        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
        }

        tr:hover {
            background-color: #f8f9fa;
        }

        /* æŒ‰éˆ•æ¨£å¼ */
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.3s;
        }

        .btn-primary {
            background-color: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background-color: #2980b9;
        }

        .btn-success {
            background-color: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background-color: #229954;
        }

        .btn-danger {
            background-color: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background-color: #c0392b;
        }

        .btn-small {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
        }

        /* è¡¨å–®æ¨£å¼ */
        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }

        .form-control:focus {
            outline: none;
            border-color: #3498db;
        }

        /* é€²åº¦æ¢ */
        .progress {
            width: 100%;
            height: 20px;
            background-color: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 0.5rem;
        }

        .progress-bar {
            height: 100%;
            background-color: #3498db;
            transition: width 0.3s ease;
        }

        /* æ—¥èªŒå€åŸŸ */
        .log-container {
            background-color: #2c3e50;
            color: #ecf0f1;
            padding: 1rem;
            border-radius: 4px;
            height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
        }

        .log-entry {
            margin-bottom: 0.25rem;
        }

        .log-time {
            color: #95a5a6;
        }

        /* åˆ†é å…§å®¹ */
        .page-content {
            display: none;
        }

        .page-content.active {
            display: block;
        }

        /* è¨­å‚™å¡ç‰‡ */
        .device-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .device-info {
            flex: 1;
        }

        .device-status {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .status-online {
            background-color: #d4edda;
            color: #155724;
        }

        .status-offline {
            background-color: #f8d7da;
            color: #721c24;
        }

        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 768px) {
            .sidebar {
                display: none;
            }
            
            .main-content {
                padding: 1rem;
            }
        }

        /* åŠ è¼‰å‹•ç•« */
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* å½ˆçª—æ¨£å¼ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 2rem;
            border-radius: 8px;
            width: 80%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .close {
            position: absolute;
            right: 1rem;
            top: 1rem;
            font-size: 1.5rem;
            cursor: pointer;
            color: #aaa;
        }

        .close:hover {
            color: #000;
        }
        .map-container {
            margin-top: 1rem;
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            height: 300px;
        }
        
        .map-toolbar {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
            flex-wrap: wrap;
        }
    </style>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-o9N1j7kPvxHboV3QbE6PUYZoXBcjc9V0w6pHia1u5r0=" crossorigin="" />
</head>
<body>
    <!-- é ‚éƒ¨å°èˆªæ¬„ -->
    <nav class="navbar">
        <h1>ğŸš• æ™ºèƒ½è¨ˆç¨‹è»Šå»£å‘Šç®¡ç†ç³»çµ±</h1>
        <div class="navbar-actions">
            <span id="loginUserEmail">ç®¡ç†å“¡</span>
            <button class="btn btn-danger btn-small" onclick="logout()">ç™»å‡º</button>
        </div>
    </nav>

    <!-- ä¸»å®¹å™¨ -->
    <div class="container">
        <!-- å´é‚Šæ¬„ -->
        <aside class="sidebar">
            <button class="sidebar-item active" onclick="showPage('dashboard', event)">
                <i>ğŸ“Š</i> å„€è¡¨æ¿
            </button>
            <button class="sidebar-item" onclick="showPage('register', event)">
                <i>â•</i> è¨­å‚™è¨»å†Š
            </button>
            <button class="sidebar-item" onclick="showPage('devices', event)">
                <i>ğŸ“±</i> è¨­å‚™ç®¡ç†
            </button>
            <button class="sidebar-item" onclick="showPage('ads', event)">
                <i>ğŸ¬</i> å»£å‘Šç®¡ç†
            </button>
            <button class="sidebar-item" onclick="showPage('campaigns', event)">
                <i>ğŸ“</i> æ´»å‹•ç®¡ç†
            </button>
            <button class="sidebar-item" onclick="showPage('push', event)">
                <i>ğŸ“¢</i> æ¨é€æ§åˆ¶
            </button>
            <button class="sidebar-item" onclick="showPage('download', event)">
                <i>â¬‡ï¸</i> ä¸‹è¼‰ç®¡ç†
            </button>
            <button class="sidebar-item" onclick="showPage('logs', event)">
                <i>ğŸ“</i> ç³»çµ±æ—¥èªŒ
            </button>
        </aside>

        <!-- ä¸»å…§å®¹å€ -->
        <main class="main-content">
            <!-- å„€è¡¨æ¿é é¢ -->
            <div id="dashboardPage" class="page-content active">
                <h2>ç³»çµ±å„€è¡¨æ¿</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="activeDevices">0</div>
                        <div class="stat-label">æ´»å‹•è¨­å‚™</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalAds">0</div>
                        <div class="stat-label">å»£å‘Šç¸½æ•¸</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="activeCampaigns">0</div>
                        <div class="stat-label">æ´»å‹•æ•¸é‡</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="todayPushes">0</div>
                        <div class="stat-label">ä»Šæ—¥æ¨é€</div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title">ç³»çµ±ç‹€æ…‹</div>
                    <div id="systemStatus">
                        <p>è¼‰å…¥ä¸­...</p>
                    </div>
                </div>
            </div>

            <!-- è¨­å‚™è¨»å†Šé é¢ -->
            <div id="registerPage" class="page-content">
                <h2>è¨­å‚™è¨»å†Š</h2>
                <div class="card">
                    <div class="card-title">è¨»å†Šæ–°è¨­å‚™</div>
                    <form id="registerDeviceForm">
                        <div class="form-group">
                            <label class="form-label">è¨­å‚™ ID *</label>
                            <input type="text" id="newDeviceId" class="form-control" 
                                   placeholder="ä¾‹å¦‚: taxi-AAB-1234-rooftop" required>
                            <small style="color: #7f8c8d;">å»ºè­°æ ¼å¼: taxi-{è»Šç‰Œ}-{é¡å‹}</small>
                        </div>
                        <div class="form-group">
                            <label class="form-label">è¨­å‚™é¡å‹ *</label>
                            <select id="newDeviceType" class="form-control">
                                <option value="rooftop_display">è»Šé ‚é¡¯ç¤ºå™¨</option>
                                <option value="in_car_screen">è»Šå…§è¢å¹•</option>
                                <option value="mobile_app">æ‰‹æ©Ÿ App</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">ç¾¤çµ„æ¨™ç±¤</label>
                            <input type="text" id="newDeviceGroups" class="form-control" 
                                   placeholder="è¼¸å…¥æ¨™ç±¤ï¼Œç”¨é€—è™Ÿåˆ†éš”" value="general">
                            <small style="color: #7f8c8d;">ä¾‹å¦‚: general, premium, taipei</small>
                        </div>
                        <button type="submit" class="btn btn-success">è¨»å†Šè¨­å‚™</button>
                    </form>
                </div>

                <div class="card">
                    <div class="card-title">
                        å·²è¨»å†Šè¨­å‚™åˆ—è¡¨
                        <button class="btn btn-primary btn-small" style="float: right;" onclick="loadRegisteredDevices()">
                            ğŸ”„ åˆ·æ–°
                        </button>
                    </div>
                    <div id="registeredDevicesList">
                        <div class="loader"></div>
                    </div>
                </div>

                <div class="card" style="background: #e8f5e9;">
                    <div class="card-title">ğŸ“± é€£æ¥èªªæ˜</div>
                    <ol style="line-height: 1.8;">
                        <li>åœ¨ä¸Šæ–¹è¡¨å–®ä¸­å¡«å¯«è¨­å‚™è³‡è¨Šä¸¦é»æ“Šã€Œè¨»å†Šè¨­å‚™ã€</li>
                        <li>è¨˜ä¸‹åˆ†é…çš„è¨­å‚™ IDï¼ˆä¾‹å¦‚: taxi-AAB-1234-rooftopï¼‰</li>
                        <li>åœ¨ App ç«¯ä½¿ç”¨ä»¥ä¸‹æ–¹å¼é€£æ¥ï¼š
                            <pre style="background: #fff; padding: 10px; margin-top: 10px; border-radius: 4px;">
python tests/test_location_client.py <è¨­å‚™ID> 5

ç¯„ä¾‹:
python tests/test_location_client.py taxi-AAB-1234-rooftop 5</pre>
                        </li>
                        <li>é€£æ¥æˆåŠŸå¾Œï¼Œè¨­å‚™æœƒè‡ªå‹•å‡ºç¾åœ¨ã€Œè¨­å‚™ç®¡ç†ã€é é¢</li>
                    </ol>
                </div>
            </div>

            <!-- è¨­å‚™ç®¡ç†é é¢ -->
            <div id="devicesPage" class="page-content">
                <h2>è¨­å‚™ç®¡ç†</h2>
                <div class="card">
                    <div class="card-title">
                        ç·šä¸Šè¨­å‚™
                        <button class="btn btn-primary" style="float: right;" onclick="refreshDevices()">
                            ğŸ”„ åˆ·æ–°
                        </button>
                    </div>
                    <div id="devicesList">
                        <div class="loader"></div>
                    </div>
                </div>
            </div>

            <!-- å»£å‘Šç®¡ç†é é¢ -->
            <div id="adsPage" class="page-content">
                <h2>å»£å‘Šç®¡ç†</h2>
                <div class="card">
                    <div class="card-title">
                        å»£å‘Šåˆ—è¡¨
                        <button class="btn btn-success" style="float: right;" onclick="showCreateAdModal()">
                            â• æ–°å¢å»£å‘Š
                        </button>
                    </div>
                    <div id="adsList">
                        <div class="loader"></div>
                    </div>
                </div>
            </div>


            <!-- æ´»å‹•ç®¡ç†é é¢ -->
            <div id="campaignsPage" class="page-content">
                <h2>æ´»å‹•ç®¡ç†</h2>
                <div class="card">
                    <div class="card-title">
                        æ´»å‹•åˆ—è¡¨
                        <button class="btn btn-success" style="float: right;" onclick="showCreateCampaignModal()">
                            â• æ–°å¢æ´»å‹•
                        </button>
                    </div>
                    <div id="campaignsList">
                        <div class="loader"></div>
                    </div>
                </div>
            </div>

            <!-- æ¨é€æ§åˆ¶é é¢ -->
            <div id="pushPage" class="page-content">
                <h2>æ¨é€æ§åˆ¶</h2>
                <div class="card">
                    <div class="card-title">å³æ™‚æ¨é€å»£å‘Š</div>
                    <form id="pushForm">
                        <div class="form-group">
                            <label class="form-label">é¸æ“‡ç›®æ¨™è¨­å‚™</label>
                            <div id="deviceSelector">
                                <p>è¼‰å…¥è¨­å‚™ä¸­...</p>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">é¸æ“‡å»£å‘Š</label>
                            <select id="adSelector" class="form-control">
                                <option value="">é¸æ“‡å»£å‘Š...</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary">ç«‹å³æ¨é€</button>
                    </form>
                </div>
            </div>

            <!-- ä¸‹è¼‰ç®¡ç†é é¢ -->
            <div id="downloadPage" class="page-content">
                <h2>ä¸‹è¼‰ç®¡ç†</h2>
                <div class="card">
                    <div class="card-title">æ¨é€å½±ç‰‡ä¸‹è¼‰</div>
                    <form id="downloadForm">
                        <div class="form-group">
                            <label class="form-label">é¸æ“‡ç›®æ¨™è¨­å‚™</label>
                            <div id="downloadDeviceSelector">
                                <p>è¼‰å…¥è¨­å‚™ä¸­...</p>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">é¸æ“‡è¦ä¸‹è¼‰çš„å»£å‘Š</label>
                            <select id="downloadAdSelector" class="form-control">
                                <option value="">é¸æ“‡å»£å‘Š...</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary">æ¨é€ä¸‹è¼‰</button>
                    </form>
                </div>
            </div>

            <!-- ç³»çµ±æ—¥èªŒé é¢ -->
            <div id="logsPage" class="page-content">
                <h2>ç³»çµ±æ—¥èªŒ</h2>
                <div class="card">
                    <div class="card-title">
                        å¯¦æ™‚æ—¥èªŒ
                        <button class="btn btn-danger btn-small" style="float: right;" onclick="clearLogs()">
                            æ¸…ç©ºæ—¥èªŒ
                        </button>
                    </div>
                    <div class="log-container" id="logContainer">
                        <div class="log-entry">
                            <span class="log-time">[ç³»çµ±å•Ÿå‹•]</span> ç®¡ç†ç³»çµ±å·²å•Ÿå‹•
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- å‰µå»ºå»£å‘Šå½ˆçª— -->
    <div id="createAdModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('createAdModal')">&times;</span>
            <h3>å‰µå»ºæ–°å»£å‘Š</h3>
            <form id="createAdForm">
                <div class="form-group">
                    <label class="form-label">å»£å‘ŠID</label>
                    <input type="text" id="newAdId" class="form-control" placeholder="è‡ªå‹•ç”Ÿæˆ">
                </div>
                <div class="form-group">
                    <label class="form-label">å»£å‘Šåç¨±</label>
                    <input type="text" id="newAdName" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label">é¡å‹</label>
                    <select id="newAdType" class="form-control">
                        <option value="general">ä¸€èˆ¬å»£å‘Š</option>
                        <option value="promotion">ä¿ƒéŠ·å»£å‘Š</option>
                        <option value="event">æ´»å‹•å»£å‘Š</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">å„ªå…ˆç´š</label>
                    <input type="number" id="newAdPriority" class="form-control" min="1" max="10" value="5">
                </div>
                <div class="form-group">
                    <label class="form-label">ç›®æ¨™ç¾¤çµ„</label>
                    <input type="text" id="newAdGroups" class="form-control" placeholder="è¼¸å…¥æ¨™ç±¤ï¼Œç”¨é€—è™Ÿåˆ†éš”" value="general">
                    <small style="color: #7f8c8d;">è‹¥æœ‰å¤šå€‹ç¾¤çµ„è«‹ä»¥é€—è™Ÿåˆ†éš”ï¼Œé è¨­ç‚º general</small>
                </div>
                <div class="form-group">
                    <label class="form-label">å½±ç‰‡æ–‡ä»¶ *</label>
                    <input type="file" id="newAdFile" class="form-control" accept="video/*" required>
                </div>
                <button type="submit" class="btn btn-success">å‰µå»ºå»£å‘Š</button>
                <div id="uploadProgress" style="display: none; margin-top: 1rem;">
                    <div class="progress">
                        <div class="progress-bar" id="progressBar" style="width: 0%"></div>
                    </div>
                    <p id="progressText">æº–å‚™ä¸Šå‚³...</p>
                </div>
            </form>
        </div>
    </div>

    <!-- å‰µå»ºæ´»å‹•å½ˆçª— -->
    <div id="createCampaignModal" class="modal">
        <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
            <span class="close" onclick="closeModal('createCampaignModal')">&times;</span>
            <h3>å‰µå»ºæ–°æ´»å‹•</h3>
            <form id="createCampaignForm">
                <div class="form-group">
                    <label class="form-label">æ´»å‹•IDï¼ˆé¸å¡«ï¼‰</label>
                    <input type="text" id="newCampaignId" class="form-control" placeholder="è‡ªå‹•ç”Ÿæˆ">
                </div>
                <div class="form-group">
                    <label class="form-label">æ´»å‹•åç¨± *</label>
                    <input type="text" id="newCampaignName" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label">å„ªå…ˆç´š</label>
                    <input type="number" id="newCampaignPriority" class="form-control" min="1" max="10" value="5">
                    <small style="color: #7f8c8d;">æ•¸å€¼è¶Šå¤§å„ªå…ˆç´šè¶Šé«˜</small>
                </div>
                <div class="form-group">
                    <label class="form-label">ç›®æ¨™ç¾¤çµ„</label>
                    <input type="text" id="newCampaignGroups" class="form-control" placeholder="è¼¸å…¥æ¨™ç±¤ï¼Œç”¨é€—è™Ÿåˆ†éš”" value="general">
                    <small style="color: #7f8c8d;">ä¾‹å¦‚: general, premium, taipei</small>
                </div>
                
                <hr style="margin: 1.5rem 0;">
                
                <h4 style="margin-bottom: 1rem;">ğŸ“ GPSä½ç½®è¨­å®š</h4>
                <div class="form-group">
                    <label class="form-label">ä¸­å¿ƒé»ç¶“åº¦ *</label>
                    <input type="number" id="centerLongitude" class="form-control" step="0.000001" required placeholder="ä¾‹å¦‚: 121.5645">
                    <small style="color: #7f8c8d;">ç¯„åœ: -180 åˆ° 180</small>
                </div>
                <div class="form-group">
                    <label class="form-label">ä¸­å¿ƒé»ç·¯åº¦ *</label>
                    <input type="number" id="centerLatitude" class="form-control" step="0.000001" required placeholder="ä¾‹å¦‚: 25.0330">
                    <small style="color: #7f8c8d;">ç¯„åœ: -90 åˆ° 90</small>
                </div>
                <div class="form-group">
                    <label class="form-label">ç¯„åœåŠå¾‘ï¼ˆå…¬å°ºï¼‰*</label>
                    <input type="number" id="radiusMeters" class="form-control" min="10" max="10000" value="500" required>
                    <small style="color: #7f8c8d;">è¨­å‚™é€²å…¥æ­¤ç¯„åœå…§æœƒè§¸ç™¼å»£å‘Šæ’­æ”¾</small>
                </div>

                <div class="form-group">
                    <label class="form-label">ä½¿ç”¨åœ°åœ–é¸æ“‡ä½ç½®</label>
                    <div id="campaignMap" class="map-container"></div>
                    <div class="map-toolbar">
                        <button type="button" class="btn btn-primary btn-small" onclick="locateCurrentPosition()">
                            ğŸ“ ä½¿ç”¨ç›®å‰å®šä½
                        </button>
                        <button type="button" class="btn btn-primary btn-small" onclick="centerMapToInputs()">
                            ğŸ¯ å°‡åœ°åœ–ç§»è‡³è¼¸å…¥åº§æ¨™
                        </button>
                        <small style="color: #7f8c8d; flex: 1 1 100%;">
                            å°æç¤ºï¼šé»æ“Šåœ°åœ–æˆ–æ‹–æ›³æ¨™è¨˜å³å¯æ›´æ–°ç¶“ç·¯åº¦æ¬„ä½
                        </small>
                    </div>
                </div>
                
                <hr style="margin: 1.5rem 0;">
                
                <h4 style="margin-bottom: 1rem;">ğŸ¬ å»£å‘Šåˆ—è¡¨ï¼ˆå¾ªç’°æ’­æ”¾ï¼‰</h4>
                <div class="form-group">
                    <label class="form-label">é¸æ“‡å»£å‘Š *</label>
                    <div id="campaignAdSelector" style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 4px;">
                        <p>è¼‰å…¥å»£å‘Šä¸­...</p>
                    </div>
                    <small style="color: #7f8c8d;">å¯é¸æ“‡å¤šå€‹å»£å‘Šï¼Œè¨­å‚™æœƒå¾ªç’°æ’­æ”¾é€™äº›å»£å‘Š</small>
                </div>
                
                <button type="submit" class="btn btn-success">å‰µå»ºæ´»å‹•</button>
            </form>
        </div>
    </div>

    <!-- ç¬¬ä¸‰æ–¹å‡½å¼åº« -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-SmSRN1ogbH0GkM1Jr1cOGn97d8iRgx0G2v+rj0i0X6Y=" crossorigin=""></script>

    <!-- Socket.IO å®¢æˆ¶ç«¯åº« -->
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    
    <script>

        const LOGIN_PAGE = 'login.html';

        if (localStorage.getItem('admin_logged_in') !== 'true') {
            window.location.href = LOGIN_PAGE;
        }

        // Socket.IO é€£æ¥
        let socket = null;
        // API åŸºç¤è·¯å¾‘
        // è‡ªå‹•åµæ¸¬ç›®å‰ç¶²åŸŸèˆ‡å”å®š
        const API_BASE = window.location.origin + '/api/v1/admin';
        // æ›´ç©©å®šç‰ˆæœ¬ï¼ˆAzure App Service å°ˆç”¨ï¼‰
        const SOCKETIO_URL = window.location.origin;

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initWebSocket();
            loadDashboard();
            setupEventListeners();
            setLoginUserInfo();
        });

        // socket = io(SOCKETIO_URL, {
        //     transports: ['websocket'],  // ä¿ç•™ç´” websocket
        //     reconnection: true,
        //     reconnectionDelay: 5000,
        //     reconnectionAttempts: Infinity
        // });


        // ç•¶å‰é é¢
        let currentPage = 'dashboard';
        

        
        // åˆå§‹åŒ– WebSocket (ä½¿ç”¨ Socket.IO)
        function initWebSocket() {
            try {
                // å¦‚æœå·²ç¶“æœ‰é€£æ¥ï¼Œå…ˆæ–·é–‹
                if (socket) {
                    socket.disconnect();
                }
                
                // å»ºç«‹ Socket.IO é€£æ¥
                socket = io(SOCKETIO_URL, {
                    transports: ['websocket'],
                    reconnection: true,
                    reconnectionDelay: 5000,
                    reconnectionAttempts: Infinity
                });
                
                socket.on('connect', function() {
                    addLog('Socket.IO é€£æ¥å·²å»ºç«‹ (SID: ' + socket.id + ')', 'info');
                });
                
                socket.on('disconnect', function() {
                    addLog('Socket.IO é€£æ¥å·²æ–·é–‹', 'warning');
                });
                
                socket.on('connect_error', function(error) {
                    addLog('Socket.IO é€£æ¥éŒ¯èª¤: ' + error.message, 'error');
                });
                
                socket.on('connection_established', function(data) {
                    addLog('æœå‹™å™¨ç¢ºèªé€£æ¥: ' + data.message, 'info');
                });
                
                // ç›£è½è¨­å‚™é€£æ¥/æ–·é–‹äº‹ä»¶
                socket.on('device_status', function(data) {
                    handleWebSocketMessage(data);
                });
                
            } catch (error) {
                addLog('åˆå§‹åŒ– Socket.IO å¤±æ•—: ' + error.message, 'error');
            }
        }
        
        // è™•ç† WebSocket æ¶ˆæ¯
        function handleWebSocketMessage(data) {
            switch(data.type) {
                case 'device_connected':
                    addLog(`è¨­å‚™ ${data.device_id} å·²é€£æ¥`, 'info');
                    if (currentPage === 'dashboard' || currentPage === 'devices') {
                        loadDashboard();
                    }
                    break;
                case 'device_disconnected':
                    addLog(`è¨­å‚™ ${data.device_id} å·²æ–·é–‹`, 'warning');
                    if (currentPage === 'dashboard' || currentPage === 'devices') {
                        loadDashboard();
                    }
                    break;
            }
        }
        
        // é¡¯ç¤ºé é¢
        function showPage(pageName,event) {
            // éš±è—æ‰€æœ‰é é¢
            document.querySelectorAll('.page-content').forEach(page => {
                page.classList.remove('active');
            });
            
            // æ›´æ–°å´é‚Šæ¬„
            document.querySelectorAll('.sidebar-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // é¡¯ç¤ºé¸ä¸­é é¢
            document.getElementById(pageName + 'Page').classList.add('active');
            event.target.classList.add('active');
            
            currentPage = pageName;
            
            // è¼‰å…¥é é¢æ•¸æ“š
            switch(pageName) {
                case 'dashboard':
                    loadDashboard();
                    break;
                case 'register':
                    loadRegisteredDevices();
                    break;
                case 'devices':
                    loadDevices();
                    break;
                case 'ads':
                    loadAds();
                    break;
                case 'campaigns':
                    loadCampaigns();
                    break;
                case 'push':
                    loadPushPage();
                    break;
                case 'download':
                    loadDownloadPage();
                    break;
            }
        }
        
        // è¨»å†Šæ–°è¨­å‚™
        async function registerDevice() {
            const deviceId = document.getElementById('newDeviceId').value.trim();
            const deviceType = document.getElementById('newDeviceType').value;
            const groupsInput = document.getElementById('newDeviceGroups').value;
            
            // è§£æç¾¤çµ„æ¨™ç±¤
            const groups = groupsInput.split(',').map(g => g.trim()).filter(g => g);
            
            if (!deviceId) {
                alert('è«‹è¼¸å…¥è¨­å‚™ ID');
                return;
            }
            
            try {
                const response = await fetch(API_BASE + '/devices', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        device_id: deviceId,
                        device_type: deviceType,
                        groups: groups.length > 0 ? groups : ['general']
                    })
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    addLog(`è¨­å‚™è¨»å†ŠæˆåŠŸ: ${deviceId}`, 'success');
                    alert(`âœ… è¨­å‚™è¨»å†ŠæˆåŠŸï¼\n\nè¨­å‚™ ID: ${deviceId}\n\nè«‹ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤é€£æ¥ï¼š\npython tests/test_location_client.py ${deviceId} 5`);
                    
                    // é‡ç½®è¡¨å–®
                    document.getElementById('registerDeviceForm').reset();
                    document.getElementById('newDeviceGroups').value = 'general';
                    
                    // åˆ·æ–°è¨­å‚™åˆ—è¡¨
                    loadRegisteredDevices();
                } else {
                    throw new Error(data.message || 'è¨»å†Šå¤±æ•—');
                }
            } catch (error) {
                addLog('è¨­å‚™è¨»å†Šå¤±æ•—: ' + error.message, 'error');
                alert('è¨­å‚™è¨»å†Šå¤±æ•—: ' + error.message);
            }
        }
        
        // è¼‰å…¥å·²è¨»å†Šè¨­å‚™åˆ—è¡¨
        async function loadRegisteredDevices() {
            try {
                const response = await fetch(API_BASE + '/devices');
                const data = await response.json();
                
                const devicesList = document.getElementById('registeredDevicesList');
                
                if (data.devices && data.devices.length > 0) {
                    devicesList.innerHTML = `
                        <table>
                            <thead>
                                <tr>
                                    <th>è¨­å‚™ ID</th>
                                    <th>è¨­å‚™é¡å‹</th>
                                    <th>ç¾¤çµ„</th>
                                    <th>ç‹€æ…‹</th>
                                    <th>è¨»å†Šæ™‚é–“</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.devices.map(device => `
                                    <tr>
                                        <td><strong>${device.device_id}</strong></td>
                                        <td>${getDeviceTypeLabel(device.device_type)}</td>
                                        <td>${device.groups ? device.groups.join(', ') : '-'}</td>
                                        <td>
                                            <span class="device-status ${device.is_online ? 'status-online' : 'status-offline'}">
                                                ${device.is_online ? 'ç·šä¸Š' : 'é›¢ç·š'}
                                            </span>
                                        </td>
                                        <td>${device.created_at ? new Date(device.created_at).toLocaleString('zh-TW') : '-'}</td>
                                        <td>
                                            <button class="btn btn-primary btn-small" onclick="copyDeviceId('${device.device_id}')">
                                                è¤‡è£½ ID
                                            </button>
                                            <button class="btn btn-danger btn-small" onclick="deleteDevice('${device.device_id}')">
                                                åˆªé™¤
                                            </button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                } else {
                    devicesList.innerHTML = '<p>ç›®å‰æ²’æœ‰å·²è¨»å†Šçš„è¨­å‚™</p>';
                }
            } catch (error) {
                addLog('è¼‰å…¥è¨­å‚™åˆ—è¡¨å¤±æ•—: ' + error.message, 'error');
                document.getElementById('registeredDevicesList').innerHTML = '<p>è¼‰å…¥å¤±æ•—</p>';
            }
        }
        
        // è¤‡è£½è¨­å‚™ ID åˆ°å‰ªè²¼ç°¿
        async function copyDeviceId(deviceId) {
            try {
                await navigator.clipboard.writeText(deviceId);
                alert('âœ… è¨­å‚™ ID å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼\n\n' + deviceId);
            } catch (err) {
                // é™ç´šæ–¹æ¡ˆ
                const textArea = document.createElement('textarea');
                textArea.value = deviceId;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('âœ… è¨­å‚™ ID å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼\n\n' + deviceId);
            }
        }
        
        // åˆªé™¤è¨­å‚™
        async function deleteDevice(deviceId) {
            if (!confirm(`ç¢ºå®šè¦åˆªé™¤è¨­å‚™ ${deviceId} å—ï¼Ÿ`)) {
                return;
            }
            
            try {
                const response = await fetch(API_BASE + `/devices/${deviceId}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                if (data.status === 'success') {
                    addLog(`è¨­å‚™å·²åˆªé™¤: ${deviceId}`, 'info');
                    loadRegisteredDevices();
                } else {
                    throw new Error(data.message);
                }
            } catch (error) {
                addLog('åˆªé™¤è¨­å‚™å¤±æ•—: ' + error.message, 'error');
                alert('åˆªé™¤å¤±æ•—: ' + error.message);
            }
        }
        
        // ç²å–è¨­å‚™é¡å‹æ¨™ç±¤
        function getDeviceTypeLabel(type) {
            const labels = {
                'rooftop_display': 'è»Šé ‚é¡¯ç¤ºå™¨',
                'in_car_screen': 'è»Šå…§è¢å¹•',
                'mobile_app': 'æ‰‹æ©Ÿ App'
            };
            return labels[type] || type;
        }
        
        // è¼‰å…¥å„€è¡¨æ¿
        async function loadDashboard() {
            try {
                // ç²å–çµ±è¨ˆæ•¸æ“š
                const [connectionsRes, adsRes, campaignsRes, healthRes] = await Promise.all([
                    fetch(API_BASE + '/connections'),
                    fetch(API_BASE + '/advertisements?status=active'),
                    fetch(API_BASE + '/campaigns?status=active'),
                    fetch(window.location.origin + '/health')
                ]);
                
                const connections = await connectionsRes.json();
                const ads = await adsRes.json();
                const campaigns = await campaignsRes.json();
                const health = await healthRes.json();
                
                // æ›´æ–°çµ±è¨ˆ
                document.getElementById('activeDevices').textContent = connections.active_devices?.length || 0;
                document.getElementById('totalAds').textContent = ads.total || 0;
                document.getElementById('activeCampaigns').textContent = campaigns.total || 0;
                document.getElementById('todayPushes').textContent = connections.stats?.messages_sent || 0;
                
                // æ›´æ–°ç³»çµ±ç‹€æ…‹
                document.getElementById('systemStatus').innerHTML = `
                    <p>æœå‹™ç‹€æ…‹: <span style="color: #27ae60;">é‹è¡Œä¸­</span></p>
                    <p>æ•¸æ“šåº«ç‹€æ…‹: ${health.database}</p>
                    <p>æ´»å‹•é€£æ¥æ•¸: ${health.active_connections}</p>
                    <p>æœå‹™å™¨æ™‚é–“: ${new Date().toLocaleString('zh-TW')}</p>
                `;
            } catch (error) {
                addLog('è¼‰å…¥å„€è¡¨æ¿å¤±æ•—: ' + error.message, 'error');
            }
        }
        
        // è¼‰å…¥è¨­å‚™åˆ—è¡¨
        async function loadDevices() {
            try {
                const [connectionsRes, devicesRes] = await Promise.all([
                    fetch(API_BASE + '/connections'),
                    fetch(API_BASE + '/devices')
                ]);
                
                const connectionsData = await connectionsRes.json();
                const devicesData = await devicesRes.json();
                
                const deviceMeta = {};
                if (devicesData.devices && Array.isArray(devicesData.devices)) {
                    devicesData.devices.forEach(device => {
                        const deviceId = device.device_id || device._id;
                        if (deviceId) {
                            deviceMeta[deviceId] = device;
                        }
                    });
                }
                
                const devicesList = document.getElementById('devicesList');
                
                if (connectionsData.active_devices && connectionsData.active_devices.length > 0) {
                    devicesList.innerHTML = connectionsData.active_devices.map(device => {
                        const detail = deviceMeta[device.device_id] || {};
                        const locationHtml = renderDeviceLocation(detail);
                        return `
                        <div class="device-card">
                            <div class="device-info">
                                <h4>${device.device_id}</h4>
                                <p>é€£æ¥æ™‚é–“: ${new Date(device.connected_at).toLocaleString('zh-TW')}</p>
                                <p>æœ€å¾Œæ´»å‹•: ${new Date(device.last_activity).toLocaleString('zh-TW')}</p>
                                ${locationHtml}
                            </div>
                            <div>
                                <span class="device-status status-online">ç·šä¸Š</span>
                                <button class="btn btn-primary btn-small" onclick="pushToDevice('${device.device_id}')">
                                    æ¨é€
                                </button>
                            </div>
                        </div>
                    `;
                    }).join('');
                } else {
                    devicesList.innerHTML = '<p>ç›®å‰æ²’æœ‰ç·šä¸Šè¨­å‚™</p>';
                }
            } catch (error) {
                addLog('è¼‰å…¥è¨­å‚™åˆ—è¡¨å¤±æ•—: ' + error.message, 'error');
            }
        }
        
        // è¼‰å…¥å»£å‘Šåˆ—è¡¨
        async function loadAds() {
            try {
                const response = await fetch(API_BASE + '/advertisements?status=active');
                const data = await response.json();
                
                const adsList = document.getElementById('adsList');
                
                if (data.advertisements && data.advertisements.length > 0) {
                    adsList.innerHTML = `
                        <table>
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>åç¨±</th>
                                    <th>æ–‡ä»¶å</th>
                                    <th>å¤§å°</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.advertisements.map(ad => `
                                    <tr>
                                        <td>${ad.advertisement_id}</td>
                                        <td>${ad.name}</td>
                                        <td>${ad.video_filename || '-'}</td>
                                        <td>${ad.file_size ? formatFileSize(ad.file_size) : '-'}</td>
                                        <td>
                                            <button class="btn btn-danger btn-small" onclick="deleteAd('${ad.advertisement_id}')">
                                                åˆªé™¤
                                            </button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                } else {
                    adsList.innerHTML = '<p>ç›®å‰æ²’æœ‰å»£å‘Š</p>';
                }
            } catch (error) {
                addLog('è¼‰å…¥å»£å‘Šåˆ—è¡¨å¤±æ•—: ' + error.message, 'error');
            }
        }
        
        // è¼‰å…¥æ´»å‹•åˆ—è¡¨
        async function loadCampaigns() {
            try {
                const response = await fetch(API_BASE + '/campaigns?status=active');
                const data = await response.json();
                
                const campaignsList = document.getElementById('campaignsList');
                
                if (data.campaigns && data.campaigns.length > 0) {
                    campaignsList.innerHTML = `
                        <table>
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>åç¨±</th>
                                    <th>å»£å‘Šåˆ—è¡¨</th>
                                    <th>ä¸­å¿ƒä½ç½®</th>
                                    <th>ç¯„åœ</th>
                                    <th>å„ªå…ˆç´š</th>
                                    <th>ç›®æ¨™ç¾¤çµ„</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.campaigns.map(campaign => {
                                    // å®‰å…¨åœ°ç²å–ä¸­å¿ƒä½ç½®
                                    let centerText = '-';
                                    try {
                                        if (campaign.center_location && campaign.center_location.coordinates) {
                                            const coords = campaign.center_location.coordinates;
                                            if (Array.isArray(coords) && coords.length >= 2 && 
                                                typeof coords[0] === 'number' && typeof coords[1] === 'number') {
                                                centerText = `(${coords[0].toFixed(6)}, ${coords[1].toFixed(6)})`;
                                            }
                                        } else if (campaign.geo_fence && campaign.geo_fence.coordinates) {
                                            // å˜—è©¦å¾åœ°ç†åœæ¬„çš„ç¬¬ä¸€å€‹é»ç²å–ä¸­å¿ƒä½ç½®
                                            const firstPoint = campaign.geo_fence.coordinates[0];
                                            if (Array.isArray(firstPoint) && firstPoint.length > 0) {
                                                const point = Array.isArray(firstPoint[0]) ? firstPoint[0] : firstPoint;
                                                if (Array.isArray(point) && point.length >= 2 && 
                                                    typeof point[0] === 'number' && typeof point[1] === 'number') {
                                                    centerText = `(${point[0].toFixed(6)}, ${point[1].toFixed(6)})`;
                                                }
                                            }
                                        }
                                    } catch (e) {
                                        centerText = '-';
                                    }
                                    
                                    const radius = campaign.radius_meters ? `${campaign.radius_meters} å…¬å°º` : '-';
                                    const ads = campaign.advertisement_ids || (campaign.advertisement_id ? [campaign.advertisement_id] : []);
                                    const adsText = ads.length > 0 ? `${ads.length} å€‹å»£å‘Š` : '-';
                                    
                                    return `
                                        <tr>
                                            <td>${campaign.campaign_id}</td>
                                            <td><strong>${campaign.name}</strong></td>
                                            <td>${adsText}</td>
                                            <td>${centerText}</td>
                                            <td>${radius}</td>
                                            <td>${campaign.priority || '-'}</td>
                                            <td>${campaign.target_groups ? campaign.target_groups.join(', ') : '-'}</td>
                                            <td>
                                                <button class="btn btn-primary btn-small" onclick="viewCampaignDetail('${campaign.campaign_id}')">
                                                    æŸ¥çœ‹
                                                </button>
                                                <button class="btn btn-danger btn-small" style="margin-left: 0.5rem;" onclick="deleteCampaign('${campaign.campaign_id}')">
                                                    åˆªé™¤
                                                </button>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    `;
                } else {
                    campaignsList.innerHTML = '<p>ç›®å‰æ²’æœ‰æ´»å‹•</p>';
                }
            } catch (error) {
                addLog('è¼‰å…¥æ´»å‹•åˆ—è¡¨å¤±æ•—: ' + error.message, 'error');
            }
        }
        
        // è¼‰å…¥æ¨é€é é¢
        async function loadPushPage() {
            try {
                // è¼‰å…¥è¨­å‚™åˆ—è¡¨
                const devicesRes = await fetch(API_BASE + '/connections');
                const devicesData = await devicesRes.json();
                
                const deviceSelector = document.getElementById('deviceSelector');
                if (devicesData.active_devices && devicesData.active_devices.length > 0) {
                    deviceSelector.innerHTML = devicesData.active_devices.map(device => `
                        <label>
                            <input type="checkbox" name="devices" value="${device.device_id}">
                            ${device.device_id}
                        </label><br>
                    `).join('');
                } else {
                    deviceSelector.innerHTML = '<p>æ²’æœ‰ç·šä¸Šè¨­å‚™</p>';
                }
                
                // è¼‰å…¥å»£å‘Šåˆ—è¡¨
                const adsRes = await fetch(API_BASE + '/advertisements?status=active');
                const adsData = await adsRes.json();
                
                const adSelector = document.getElementById('adSelector');
                adSelector.innerHTML = '<option value="">é¸æ“‡å»£å‘Š...</option>' +
                    adsData.advertisements.map(ad => 
                        `<option value="${ad.advertisement_id}">${ad.name} (${ad.video_filename})</option>`
                    ).join('');
            } catch (error) {
                addLog('è¼‰å…¥æ¨é€é é¢å¤±æ•—: ' + error.message, 'error');
            }
        }
        
        // è¼‰å…¥ä¸‹è¼‰é é¢
        async function loadDownloadPage() {
            try {
                // è¼‰å…¥è¨­å‚™åˆ—è¡¨
                const devicesRes = await fetch(API_BASE + '/connections');
                const devicesData = await devicesRes.json();
                
                const deviceSelector = document.getElementById('downloadDeviceSelector');
                if (devicesData.active_devices && devicesData.active_devices.length > 0) {
                    deviceSelector.innerHTML = devicesData.active_devices.map(device => `
                        <label>
                            <input type="checkbox" name="downloadDevices" value="${device.device_id}">
                            ${device.device_id}
                        </label><br>
                    `).join('');
                } else {
                    deviceSelector.innerHTML = '<p>æ²’æœ‰ç·šä¸Šè¨­å‚™</p>';
                }
                
                // è¼‰å…¥æœ‰å½±ç‰‡çš„å»£å‘Šåˆ—è¡¨
                const adsRes = await fetch(API_BASE + '/advertisements/available?with_files=true');
                const adsData = await adsRes.json();
                
                const adSelector = document.getElementById('downloadAdSelector');
                adSelector.innerHTML = '<option value="">é¸æ“‡å»£å‘Š...</option>' +
                    adsData.advertisements.map(ad => 
                        `<option value="${ad.advertisement_id}">${ad.name} (${formatFileSize(ad.file_size)})</option>`
                    ).join('');
            } catch (error) {
                addLog('è¼‰å…¥ä¸‹è¼‰é é¢å¤±æ•—: ' + error.message, 'error');
            }
        }
        
        // è¨­ç½®äº‹ä»¶ç›£è½å™¨
        function setupEventListeners() {
            // è¨­å‚™è¨»å†Šè¡¨å–®
            document.getElementById('registerDeviceForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                await registerDevice();
            });
            
            // æ¨é€è¡¨å–®
            document.getElementById('pushForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                await pushAdvertisement();
            });
            
            // ä¸‹è¼‰è¡¨å–®
            document.getElementById('downloadForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                await pushDownload();
            });
            
            // å‰µå»ºå»£å‘Šè¡¨å–®
            document.getElementById('createAdForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                await createAdvertisement();
            });
            
            // å‰µå»ºæ´»å‹•è¡¨å–®
            document.getElementById('createCampaignForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                await createCampaign();
            });

            // ç¶å®šç¶“ç·¯åº¦è¼¸å…¥çš„åŒæ­¥äº‹ä»¶
            document.getElementById('centerLongitude').addEventListener('change', () => {
                updateMapFromInputs();
            });
            document.getElementById('centerLatitude').addEventListener('change', () => {
                updateMapFromInputs();
            });
        }
        
        // é¡¯ç¤ºå‰µå»ºæ´»å‹•å½ˆçª—
        async function showCreateCampaignModal() {
            // è¼‰å…¥å»£å‘Šåˆ—è¡¨
            try {
                const response = await fetch(API_BASE + '/advertisements?status=active');
                const data = await response.json();
                
                const adSelector = document.getElementById('campaignAdSelector');
                if (data.advertisements && data.advertisements.length > 0) {
                    adSelector.innerHTML = data.advertisements.map(ad => `
                        <label style="display: block; padding: 5px;">
                            <input type="checkbox" name="campaignAds" value="${ad.advertisement_id}" style="margin-right: 8px;">
                            ${ad.name} (${ad.video_filename || 'ç„¡å½±ç‰‡'})
                        </label>
                    `).join('');
                } else {
                    adSelector.innerHTML = '<p>ç›®å‰æ²’æœ‰å¯ç”¨çš„å»£å‘Šï¼Œè«‹å…ˆä¸Šå‚³å»£å‘Š</p>';
                }
            } catch (error) {
                addLog('è¼‰å…¥å»£å‘Šåˆ—è¡¨å¤±æ•—: ' + error.message, 'error');
                document.getElementById('campaignAdSelector').innerHTML = '<p>è¼‰å…¥å¤±æ•—</p>';
            }
            
            document.getElementById('createCampaignModal').style.display = 'block';
            setTimeout(() => {
                initCampaignMap();
            }, 50);
        }
        
        function initCampaignMap() {
            const defaultLng = parseFloat(document.getElementById('centerLongitude').value) || 121.5645;
            const defaultLat = parseFloat(document.getElementById('centerLatitude').value) || 25.0330;
            const initialCoords = [defaultLat, defaultLng];

            if (!campaignMap) {
                campaignMap = L.map('campaignMap').setView(initialCoords, 13);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    attribution: '&copy; OpenStreetMap è²¢ç»è€…'
                }).addTo(campaignMap);

                campaignMapMarker = L.marker(initialCoords, { draggable: true }).addTo(campaignMap);

                campaignMap.on('click', function (event) {
                    updateMarkerAndInputs(event.latlng);
                });

                campaignMapMarker.on('dragend', function (event) {
                    const latlng = event.target.getLatLng();
                    updateInputsFromLatLng(latlng);
                });
            } else {
                campaignMap.setView(initialCoords, campaignMap.getZoom());
                campaignMapMarker.setLatLng(initialCoords);
            }

            setTimeout(() => {
                campaignMap.invalidateSize();
            }, 100);
        }

        function updateMapFromInputs() {
            if (!campaignMap) return;
            const lng = parseFloat(document.getElementById('centerLongitude').value);
            const lat = parseFloat(document.getElementById('centerLatitude').value);
            if (isNaN(lng) || isNaN(lat)) return;
            const coords = { lat, lng };
            campaignMap.setView(coords, campaignMap.getZoom());
            campaignMapMarker.setLatLng(coords);
        }

        function updateMarkerAndInputs(latlng) {
            campaignMapMarker.setLatLng(latlng);
            updateInputsFromLatLng(latlng);
        }

        function updateInputsFromLatLng(latlng) {
            document.getElementById('centerLongitude').value = latlng.lng.toFixed(6);
            document.getElementById('centerLatitude').value = latlng.lat.toFixed(6);
        }

        function locateCurrentPosition() {
            if (!navigator.geolocation) {
                alert('ç€è¦½å™¨ä¸æ”¯æ´å®šä½åŠŸèƒ½');
                return;
            }

            navigator.geolocation.getCurrentPosition(position => {
                const latlng = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };
                if (!campaignMap) initCampaignMap();
                campaignMap.setView(latlng, 15);
                updateMarkerAndInputs(latlng);
            }, error => {
                alert('å–å¾—å®šä½å¤±æ•—: ' + error.message);
            });
        }

        function centerMapToInputs() {
            updateMapFromInputs();
        }

        function setLoginUserInfo() {
            const email = localStorage.getItem('admin_login_email') || 'ç®¡ç†å“¡';
            const emailSpan = document.getElementById('loginUserEmail');
            if (emailSpan) {
                emailSpan.textContent = email;
            }
        }

        function logout() {
            localStorage.removeItem('admin_logged_in');
            localStorage.removeItem('admin_login_email');
            window.location.href = LOGIN_PAGE;
        }

        // å‰µå»ºæ´»å‹•
        async function createCampaign() {
            const campaignId = document.getElementById('newCampaignId').value.trim();
            const campaignName = document.getElementById('newCampaignName').value.trim();
            const priority = parseInt(document.getElementById('newCampaignPriority').value) || 5;
            const groupsInput = document.getElementById('newCampaignGroups').value.trim();
            const centerLongitude = parseFloat(document.getElementById('centerLongitude').value);
            const centerLatitude = parseFloat(document.getElementById('centerLatitude').value);
            const radiusMeters = parseInt(document.getElementById('radiusMeters').value);
            
            // ç²å–é¸ä¸­çš„å»£å‘Š
            const selectedAds = Array.from(document.querySelectorAll('input[name="campaignAds"]:checked'))
                .map(cb => cb.value);
            
            // é©—è­‰
            if (!campaignName) {
                alert('è«‹è¼¸å…¥æ´»å‹•åç¨±');
                return;
            }
            
            if (isNaN(centerLongitude) || isNaN(centerLatitude)) {
                alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„GPSåº§æ¨™');
                return;
            }
            
            if (isNaN(radiusMeters) || radiusMeters < 10) {
                alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„ç¯„åœåŠå¾‘ï¼ˆè‡³å°‘10å…¬å°ºï¼‰');
                return;
            }
            
            if (selectedAds.length === 0) {
                alert('è«‹è‡³å°‘é¸æ“‡ä¸€å€‹å»£å‘Š');
                return;
            }
            
            // è§£æç¾¤çµ„æ¨™ç±¤
            const groups = groupsInput.split(',').map(g => g.trim()).filter(g => g);
            
            try {
                const response = await fetch(API_BASE + '/campaigns', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        campaign_id: campaignId || undefined,
                        name: campaignName,
                        advertisement_ids: selectedAds,
                        priority: priority,
                        target_groups: groups.length > 0 ? groups : ['general'],
                        center_location: {
                            longitude: centerLongitude,
                            latitude: centerLatitude
                        },
                        radius_meters: radiusMeters
                    })
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    addLog(`æ´»å‹•å‰µå»ºæˆåŠŸ: ${data.campaign_id}`, 'success');
                    alert('âœ… æ´»å‹•å‰µå»ºæˆåŠŸï¼\n\næ´»å‹•ID: ' + data.campaign_id + '\n\nç•¶è¨­å‚™é€²å…¥æ­¤ç¯„åœæ™‚ï¼Œæœƒè‡ªå‹•ä¸‹è¼‰ä¸¦å¾ªç’°æ’­æ”¾é¸ä¸­çš„å»£å‘Šã€‚');
                    closeModal('createCampaignModal');
                    
                    // é‡ç½®è¡¨å–®
                    document.getElementById('createCampaignForm').reset();
                    document.getElementById('newCampaignGroups').value = 'general';
                    document.getElementById('newCampaignPriority').value = '5';
                    document.getElementById('radiusMeters').value = '500';
                    
                    // åˆ·æ–°æ´»å‹•åˆ—è¡¨
                    loadCampaigns();
                } else {
                    throw new Error(data.message || 'å‰µå»ºå¤±æ•—');
                }
            } catch (error) {
                addLog('å‰µå»ºæ´»å‹•å¤±æ•—: ' + error.message, 'error');
                alert('å‰µå»ºæ´»å‹•å¤±æ•—: ' + error.message);
            }
        }
        
        // æŸ¥çœ‹æ´»å‹•è©³æƒ…
        async function viewCampaignDetail(campaignId) {
            try {
                const response = await fetch(API_BASE + `/campaigns/${campaignId}`);
                const data = await response.json();
                
                if (data.status === 'success') {
                    const campaign = data.campaign;
                    const ads = campaign.advertisements || [];
                    
                    // å®‰å…¨åœ°ç²å–ä¸­å¿ƒä½ç½®
                    let centerText = '-';
                    try {
                        if (campaign.center_location && campaign.center_location.coordinates) {
                            const coords = campaign.center_location.coordinates;
                            if (Array.isArray(coords) && coords.length >= 2 && 
                                typeof coords[0] === 'number' && typeof coords[1] === 'number') {
                                centerText = `(${coords[0].toFixed(6)}, ${coords[1].toFixed(6)})`;
                            }
                        } else if (campaign.geo_fence && campaign.geo_fence.coordinates) {
                            const firstPoint = campaign.geo_fence.coordinates[0];
                            if (Array.isArray(firstPoint) && firstPoint.length > 0) {
                                const point = Array.isArray(firstPoint[0]) ? firstPoint[0] : firstPoint;
                                if (Array.isArray(point) && point.length >= 2 && 
                                    typeof point[0] === 'number' && typeof point[1] === 'number') {
                                    centerText = `(${point[0].toFixed(6)}, ${point[1].toFixed(6)})`;
                                }
                            }
                        }
                    } catch (e) {
                        centerText = '-';
                    }
                    
                    let message = `æ´»å‹•è©³æƒ…\n\n`;
                    message += `ID: ${campaign.campaign_id}\n`;
                    message += `åç¨±: ${campaign.name}\n`;
                    message += `å„ªå…ˆç´š: ${campaign.priority || '-'}\n`;
                    message += `ç›®æ¨™ç¾¤çµ„: ${campaign.target_groups ? campaign.target_groups.join(', ') : '-'}\n`;
                    message += `ä¸­å¿ƒä½ç½®: ${centerText}\n`;
                    message += `ç¯„åœ: ${campaign.radius_meters ? campaign.radius_meters + ' å…¬å°º' : '-'}\n\n`;
                    message += `å»£å‘Šåˆ—è¡¨ (${ads.length} å€‹):\n`;
                    if (ads.length > 0) {
                        ads.forEach((ad, index) => {
                            message += `${index + 1}. ${ad.name || 'æœªå‘½å'} (${ad.video_filename || 'ç„¡å½±ç‰‡'})\n`;
                        });
                    } else {
                        message += `ç„¡å»£å‘Š\n`;
                    }
                    
                    alert(message);
                } else {
                    throw new Error(data.message);
                }
            } catch (error) {
                addLog('ç²å–æ´»å‹•è©³æƒ…å¤±æ•—: ' + error.message, 'error');
                alert('ç²å–æ´»å‹•è©³æƒ…å¤±æ•—: ' + error.message);
            }
        }
        
        // åˆªé™¤æ´»å‹•
        async function deleteCampaign(campaignId) {
            if (!confirm(`ç¢ºå®šè¦åˆªé™¤æ´»å‹• ${campaignId} å—ï¼Ÿ`)) {
                return;
            }
            
            try {
                const response = await fetch(API_BASE + `/campaigns/${campaignId}`, {
                    method: 'DELETE'
                });
                const data = await response.json();
                
                if (data.status === 'success') {
                    const affected = Array.isArray(data.affected_devices) ? data.affected_devices : [];
                    const affectedMsg = affected.length > 0 ? `ï¼Œå·²é€šçŸ¥ ${affected.length} å°è¨­å‚™ï¼ˆ${affected.join(', ')}ï¼‰` : '';
                    addLog(`æ´»å‹•å·²åˆªé™¤: ${campaignId}${affectedMsg}`, 'info');
                    alert(`âœ… æ´»å‹•å·²åˆªé™¤ï¼\n\næ´»å‹•ID: ${campaignId}\nå—å½±éŸ¿è¨­å‚™ï¼š${affected.length} å°`);
                    loadCampaigns();
                } else {
                    throw new Error(data.message || 'åˆªé™¤å¤±æ•—');
                }
            } catch (error) {
                addLog('åˆªé™¤æ´»å‹•å¤±æ•—: ' + error.message, 'error');
                alert('åˆªé™¤æ´»å‹•å¤±æ•—: ' + error.message);
            }
        }
        
        // æ¨é€å»£å‘Š
        async function pushAdvertisement() {
            const selectedDevices = Array.from(document.querySelectorAll('input[name="devices"]:checked'))
                .map(cb => cb.value);
            const adId = document.getElementById('adSelector').value;
            
            if (selectedDevices.length === 0 || !adId) {
                alert('è«‹é¸æ“‡è¨­å‚™å’Œå»£å‘Š');
                return;
            }
            
            try {
                const response = await fetch(API_BASE + '/override', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        target_device_ids: selectedDevices,
                        advertisement_id: adId
                    })
                });
                
                const data = await response.json();
                if (data.status === 'success') {
                    addLog(`æ¨é€æˆåŠŸ: ${data.results.sent.length} å€‹è¨­å‚™`, 'success');
                    alert('æ¨é€æˆåŠŸï¼');
                } else {
                    throw new Error(data.message);
                }
            } catch (error) {
                addLog('æ¨é€å¤±æ•—: ' + error.message, 'error');
                alert('æ¨é€å¤±æ•—: ' + error.message);
            }
        }
        
        // æ¨é€ä¸‹è¼‰
        async function pushDownload() {
            const selectedDevices = Array.from(document.querySelectorAll('input[name="downloadDevices"]:checked'))
                .map(cb => cb.value);
            const adId = document.getElementById('downloadAdSelector').value;
            
            if (selectedDevices.length === 0 || !adId) {
                alert('è«‹é¸æ“‡è¨­å‚™å’Œå»£å‘Š');
                return;
            }
            
            try {
                const response = await fetch(API_BASE + '/push/download', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        target_device_ids: selectedDevices,
                        advertisement_id: adId,
                        priority: 'normal',
                        download_mode: 'chunked'
                    })
                });
                
                const data = await response.json();
                if (data.status === 'success') {
                    addLog(`ä¸‹è¼‰æ¨é€æˆåŠŸ: ${data.results.sent.length} å€‹è¨­å‚™`, 'success');
                    alert('ä¸‹è¼‰æ¨é€æˆåŠŸï¼');
                } else {
                    throw new Error(data.message);
                }
            } catch (error) {
                addLog('ä¸‹è¼‰æ¨é€å¤±æ•—: ' + error.message, 'error');
                alert('ä¸‹è¼‰æ¨é€å¤±æ•—: ' + error.message);
            }
        }
        
        // å‰µå»ºå»£å‘Šï¼ˆå«å½±ç‰‡ä¸Šå‚³ï¼‰
        async function createAdvertisement() {
            const adIdInput = document.getElementById('newAdId').value.trim();
            const adName = document.getElementById('newAdName').value.trim();
            const adType = document.getElementById('newAdType').value;
            const adPriority = parseInt(document.getElementById('newAdPriority').value, 10) || 5;
            const groupsInput = document.getElementById('newAdGroups').value;
            const targetGroups = groupsInput
                .split(',')
                .map(g => g.trim())
                .filter(g => g);
            const fileInput = document.getElementById('newAdFile');
            const file = fileInput.files[0];
            const progressContainer = document.getElementById('uploadProgress');
            
            if (!adName) {
                alert('è«‹è¼¸å…¥å»£å‘Šåç¨±');
                return;
            }
            
            if (!file) {
                alert('è«‹é¸æ“‡è¦ä¸Šå‚³çš„å½±ç‰‡æª”æ¡ˆ');
                return;
            }
            
            const defaultChunkSize = 10 * 1024 * 1024; // 10MB
            const totalChunks = Math.max(1, Math.ceil(file.size / defaultChunkSize));
            
            if (progressContainer) {
                progressContainer.style.display = 'block';
            }
            updateProgress(0, 'æº–å‚™ä¸Šå‚³...');
            
            try {
                // Step 1. åˆå§‹åŒ–åˆ†ç‰‡ä¸Šå‚³
                const initPayload = {
                    filename: file.name,
                    total_size: file.size,
                    total_chunks: totalChunks,
                    name: adName
                };
                if (adIdInput) {
                    initPayload.advertisement_id = adIdInput;
                }
                
                const initRes = await fetch(API_BASE + '/videos/chunked/init', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(initPayload)
                });
                const initData = await initRes.json();
                if (initData.status !== 'success') {
                    throw new Error(initData.message || 'åˆå§‹åŒ–ä¸Šå‚³å¤±æ•—');
                }
                
                const uploadId = initData.upload_id;
                const serverChunkSize = initData.chunk_size || defaultChunkSize;
                const effectiveChunkSize = serverChunkSize > 0 ? serverChunkSize : defaultChunkSize;
                const effectiveTotalChunks = Math.max(1, Math.ceil(file.size / effectiveChunkSize));
                
                // Step 2. ä¸Šå‚³æ‰€æœ‰åˆ†ç‰‡
                for (let i = 0; i < effectiveTotalChunks; i++) {
                    const start = i * effectiveChunkSize;
                    const end = Math.min(start + effectiveChunkSize, file.size);
                    const chunk = file.slice(start, end);
                    
                    const formData = new FormData();
                    formData.append('upload_id', uploadId);
                    formData.append('chunk_number', i.toString());
                    formData.append('chunk', chunk);
                    
                    const chunkRes = await fetch(API_BASE + '/videos/chunked/upload', {
                        method: 'POST',
                        body: formData
                    });
                    const chunkData = await chunkRes.json();
                    if (chunkData.status !== 'success') {
                        throw new Error(chunkData.message || `ç¬¬ ${i + 1} å€‹åˆ†ç‰‡ä¸Šå‚³å¤±æ•—`);
                    }
                    
                    const progress = Math.round(((i + 1) / effectiveTotalChunks) * 100);
                    updateProgress(progress, `ä¸Šå‚³ä¸­... ${i + 1}/${effectiveTotalChunks}`);
                }
                
                // Step 3. é€šçŸ¥ä¼ºæœå™¨åˆä½µåˆ†ç‰‡
                const completeRes = await fetch(API_BASE + '/videos/chunked/complete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ upload_id: uploadId })
                });
                const completeData = await completeRes.json();
                if (completeData.status !== 'success') {
                    throw new Error(completeData.message || 'åˆä½µå½±ç‰‡å¤±æ•—');
                }
                
                const createdAdId = completeData.video_info.advertisement_id;
                
                // Step 4. æ›´æ–°å»£å‘Šå±¬æ€§ï¼ˆé¡å‹ã€å„ªå…ˆç´šã€ç¾¤çµ„ç­‰ï¼‰
                const updateRes = await fetch(API_BASE + `/advertisements/${createdAdId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: adName,
                        type: adType,
                        priority: adPriority,
                        target_groups: targetGroups.length > 0 ? targetGroups : ['general'],
                        status: 'active'
                    })
                });
                const updateData = await updateRes.json();
                if (updateRes.status >= 400 || updateData.status !== 'success') {
                    throw new Error(updateData.message || 'è¨­å®šå»£å‘Šå±¬æ€§å¤±æ•—');
                }
                
                addLog(`å»£å‘Šå‰µå»ºæˆåŠŸ: ${createdAdId}`, 'success');
                alert('å»£å‘Šèˆ‡å½±ç‰‡å·²æˆåŠŸå»ºç«‹ï¼');
                
                document.getElementById('createAdForm').reset();
                document.getElementById('newAdGroups').value = 'general';
                if (progressContainer) {
                    progressContainer.style.display = 'none';
                }
                updateProgress(0, 'æº–å‚™ä¸Šå‚³...');
                
                closeModal('createAdModal');
                loadAds();
                loadDownloadPage();
            } catch (error) {
                addLog('å‰µå»ºå»£å‘Šå¤±æ•—: ' + error.message, 'error');
                alert('å‰µå»ºå»£å‘Šå¤±æ•—: ' + error.message);
                if (progressContainer) {
                    progressContainer.style.display = 'none';
                }
                updateProgress(0, 'æº–å‚™ä¸Šå‚³...');
            }
        }
        
        // åˆªé™¤å»£å‘Š
        async function deleteAd(adId) {
            if (!confirm(`ç¢ºå®šè¦åˆªé™¤å»£å‘Š ${adId} å—ï¼Ÿ`)) {
                return;
            }
            
            try {
                const response = await fetch(API_BASE + `/advertisements/${adId}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                if (data.status === 'success') {
                    addLog(`å»£å‘Šå·²åˆªé™¤: ${adId}`, 'info');
                    loadAds();
                } else {
                    throw new Error(data.message);
                }
            } catch (error) {
                addLog('åˆªé™¤å»£å‘Šå¤±æ•—: ' + error.message, 'error');
                alert('åˆªé™¤å¤±æ•—: ' + error.message);
            }
        }
        
        // åˆ·æ–°è¨­å‚™åˆ—è¡¨
        function refreshDevices() {
            loadDevices();
            addLog('è¨­å‚™åˆ—è¡¨å·²åˆ·æ–°', 'info');
        }
        
        // æ¨é€åˆ°å–®å€‹è¨­å‚™
        async function pushToDevice(deviceId) {
            const adId = prompt('è«‹è¼¸å…¥è¦æ¨é€çš„å»£å‘ŠID:');
            if (!adId) return;
            
            try {
                const response = await fetch(API_BASE + '/override', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        target_device_ids: [deviceId],
                        advertisement_id: adId
                    })
                });
                
                const data = await response.json();
                if (data.status === 'success') {
                    addLog(`æ¨é€æˆåŠŸåˆ°è¨­å‚™: ${deviceId}`, 'success');
                    alert('æ¨é€æˆåŠŸï¼');
                } else {
                    throw new Error(data.message);
                }
            } catch (error) {
                addLog('æ¨é€å¤±æ•—: ' + error.message, 'error');
                alert('æ¨é€å¤±æ•—: ' + error.message);
            }
        }
        
        // æ›´æ–°é€²åº¦æ¢
        function updateProgress(percent, text) {
            const bar = document.getElementById('progressBar');
            const label = document.getElementById('progressText');
            if (bar) {
                bar.style.width = percent + '%';
            }
            if (label) {
                label.textContent = text;
            }
        }
        
        // æ·»åŠ æ—¥èªŒ
        function addLog(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const time = new Date().toLocaleTimeString('zh-TW');
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.innerHTML = `<span class="log-time">[${time}]</span> ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }
        
        // æ¸…ç©ºæ—¥èªŒ
        function clearLogs() {
            const logContainer = document.getElementById('logContainer');
            logContainer.innerHTML = '<div class="log-entry"><span class="log-time">[ç³»çµ±]</span> æ—¥èªŒå·²æ¸…ç©º</div>';
        }
        
        // é¡¯ç¤ºå½ˆçª—
        function showCreateAdModal() {
            const form = document.getElementById('createAdForm');
            if (form) {
                form.reset();
            }
            const groupsInput = document.getElementById('newAdGroups');
            if (groupsInput) {
                groupsInput.value = 'general';
            }
            const progressContainer = document.getElementById('uploadProgress');
            if (progressContainer) {
                progressContainer.style.display = 'none';
            }
            updateProgress(0, 'æº–å‚™ä¸Šå‚³...');
            document.getElementById('createAdModal').style.display = 'block';
        }
        
        // é—œé–‰å½ˆçª—
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        
        // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        function renderDeviceLocation(detail) {
            if (!detail || !detail.last_location || !Array.isArray(detail.last_location.coordinates)) {
                return '<p>GPSï¼šå°šç„¡è³‡æ–™</p>';
            }
            
            const [longitudeRaw, latitudeRaw] = detail.last_location.coordinates;
            const longitude = Number(longitudeRaw);
            const latitude = Number(latitudeRaw);
            
            if (!Number.isFinite(longitude) || !Number.isFinite(latitude)) {
                return '<p>GPSï¼šå°šç„¡è³‡æ–™</p>';
            }
            
            const latFixed = latitude.toFixed(6);
            const lngFixed = longitude.toFixed(6);
            
            return `
                <p>GPSï¼šç·¯åº¦ ${latFixed}ï¼Œç¶“åº¦ ${lngFixed}</p>
                <button class="btn btn-primary btn-small" type="button" onclick="openMapAt(${latitude}, ${longitude})">
                    åœ¨åœ°åœ–æŸ¥çœ‹
                </button>
            `;
        }
        
        function openMapAt(lat, lng) {
            const latNum = Number(lat);
            const lngNum = Number(lng);
            
            if (!Number.isFinite(latNum) || !Number.isFinite(lngNum)) {
                alert('ç„¡æ³•é–‹å•Ÿåœ°åœ–ï¼šGPS è³‡æ–™ç„¡æ•ˆ');
                return;
            }
            
            const url = `https://www.google.com/maps?q=${latNum},${lngNum}`;
            window.open(url, '_blank', 'noopener');
        }
        
        // é»æ“Šå½ˆçª—å¤–éƒ¨é—œé–‰
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }
    </script>
</body>
</html>
