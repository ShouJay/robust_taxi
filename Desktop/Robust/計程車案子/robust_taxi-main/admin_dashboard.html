<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½è¨ˆç¨‹è»Šå»£å‘Šç®¡ç†ç³»çµ±</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f5f7fa;
            color: #333;
        }

        /* é ‚éƒ¨å°èˆªæ¬„ */
        .navbar {
            background-color: #2c3e50;
            color: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .navbar h1 {
            font-size: 1.5rem;
            font-weight: 500;
        }

        /* ä¸»è¦å®¹å™¨ */
        .container {
            display: flex;
            min-height: calc(100vh - 60px);
        }

        /* å´é‚Šæ¬„ */
        .sidebar {
            width: 250px;
            background-color: #34495e;
            padding: 1rem 0;
        }

        .sidebar-item {
            padding: 1rem 1.5rem;
            color: #ecf0f1;
            cursor: pointer;
            transition: background-color 0.3s;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            font-size: 1rem;
        }

        .sidebar-item:hover {
            background-color: #2c3e50;
        }

        .sidebar-item.active {
            background-color: #3498db;
        }

        .sidebar-item i {
            margin-right: 0.5rem;
            width: 20px;
            display: inline-block;
        }

        /* ä¸»å…§å®¹å€ */
        .main-content {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
        }

        /* å¡ç‰‡æ¨£å¼ */
        .card {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 1.5rem;
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: #2c3e50;
        }

        /* çµ±è¨ˆå¡ç‰‡ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #3498db;
        }

        .stat-label {
            color: #7f8c8d;
            margin-top: 0.5rem;
        }

        /* è¡¨æ ¼æ¨£å¼ */
        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
        }

        tr:hover {
            background-color: #f8f9fa;
        }

        /* æŒ‰éˆ•æ¨£å¼ */
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.3s;
        }

        .btn-primary {
            background-color: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background-color: #2980b9;
        }

        .btn-success {
            background-color: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background-color: #229954;
        }

        .btn-danger {
            background-color: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background-color: #c0392b;
        }

        .btn-small {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
        }

        /* è¡¨å–®æ¨£å¼ */
        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }

        .form-control:focus {
            outline: none;
            border-color: #3498db;
        }

        /* é€²åº¦æ¢ */
        .progress {
            width: 100%;
            height: 20px;
            background-color: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 0.5rem;
        }

        .progress-bar {
            height: 100%;
            background-color: #3498db;
            transition: width 0.3s ease;
        }

        /* æ—¥èªŒå€åŸŸ */
        .log-container {
            background-color: #2c3e50;
            color: #ecf0f1;
            padding: 1rem;
            border-radius: 4px;
            height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
        }

        .log-entry {
            margin-bottom: 0.25rem;
        }

        .log-time {
            color: #95a5a6;
        }

        /* åˆ†é å…§å®¹ */
        .page-content {
            display: none;
        }

        .page-content.active {
            display: block;
        }

        /* è¨­å‚™å¡ç‰‡ */
        .device-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .device-info {
            flex: 1;
        }

        .device-status {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .status-online {
            background-color: #d4edda;
            color: #155724;
        }

        .status-offline {
            background-color: #f8d7da;
            color: #721c24;
        }

        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 768px) {
            .sidebar {
                display: none;
            }
            
            .main-content {
                padding: 1rem;
            }
        }

        /* åŠ è¼‰å‹•ç•« */
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* å½ˆçª—æ¨£å¼ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 2rem;
            border-radius: 8px;
            width: 80%;
            max-width: 600px;
            position: relative;
        }

        .close {
            position: absolute;
            right: 1rem;
            top: 1rem;
            font-size: 1.5rem;
            cursor: pointer;
            color: #aaa;
        }

        .close:hover {
            color: #000;
        }
    </style>
</head>
<body>
    <!-- é ‚éƒ¨å°èˆªæ¬„ -->
    <nav class="navbar">
        <h1>ğŸš• æ™ºèƒ½è¨ˆç¨‹è»Šå»£å‘Šç®¡ç†ç³»çµ±</h1>
    </nav>

    <!-- ä¸»å®¹å™¨ -->
    <div class="container">
        <!-- å´é‚Šæ¬„ -->
        <aside class="sidebar">
            <button class="sidebar-item active" onclick="showPage('dashboard', event)">
                <i>ğŸ“Š</i> å„€è¡¨æ¿
            </button>
            <button class="sidebar-item" onclick="showPage('register', event)">
                <i>â•</i> è¨­å‚™è¨»å†Š
            </button>
            <button class="sidebar-item" onclick="showPage('devices', event)">
                <i>ğŸ“±</i> è¨­å‚™ç®¡ç†
            </button>
            <button class="sidebar-item" onclick="showPage('ads', event)">
                <i>ğŸ¬</i> å»£å‘Šç®¡ç†
            </button>
            <button class="sidebar-item" onclick="showPage('upload', event)">
                <i>â¬†ï¸</i> å½±ç‰‡ä¸Šå‚³
            </button>
            <button class="sidebar-item" onclick="showPage('campaigns', event)">
                <i>ğŸ“</i> æ´»å‹•ç®¡ç†
            </button>
            <button class="sidebar-item" onclick="showPage('push', event)">
                <i>ğŸ“¢</i> æ¨é€æ§åˆ¶
            </button>
            <button class="sidebar-item" onclick="showPage('download', event)">
                <i>â¬‡ï¸</i> ä¸‹è¼‰ç®¡ç†
            </button>
            <button class="sidebar-item" onclick="showPage('logs', event)">
                <i>ğŸ“</i> ç³»çµ±æ—¥èªŒ
            </button>
        </aside>

        <!-- ä¸»å…§å®¹å€ -->
        <main class="main-content">
            <!-- å„€è¡¨æ¿é é¢ -->
            <div id="dashboardPage" class="page-content active">
                <h2>ç³»çµ±å„€è¡¨æ¿</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="activeDevices">0</div>
                        <div class="stat-label">æ´»å‹•è¨­å‚™</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalAds">0</div>
                        <div class="stat-label">å»£å‘Šç¸½æ•¸</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="activeCampaigns">0</div>
                        <div class="stat-label">æ´»å‹•æ•¸é‡</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="todayPushes">0</div>
                        <div class="stat-label">ä»Šæ—¥æ¨é€</div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title">ç³»çµ±ç‹€æ…‹</div>
                    <div id="systemStatus">
                        <p>è¼‰å…¥ä¸­...</p>
                    </div>
                </div>
            </div>

            <!-- è¨­å‚™è¨»å†Šé é¢ -->
            <div id="registerPage" class="page-content">
                <h2>è¨­å‚™è¨»å†Š</h2>
                <div class="card">
                    <div class="card-title">è¨»å†Šæ–°è¨­å‚™</div>
                    <form id="registerDeviceForm">
                        <div class="form-group">
                            <label class="form-label">è¨­å‚™ ID *</label>
                            <input type="text" id="newDeviceId" class="form-control" 
                                   placeholder="ä¾‹å¦‚: taxi-AAB-1234-rooftop" required>
                            <small style="color: #7f8c8d;">å»ºè­°æ ¼å¼: taxi-{è»Šç‰Œ}-{é¡å‹}</small>
                        </div>
                        <div class="form-group">
                            <label class="form-label">è¨­å‚™é¡å‹ *</label>
                            <select id="newDeviceType" class="form-control">
                                <option value="rooftop_display">è»Šé ‚é¡¯ç¤ºå™¨</option>
                                <option value="in_car_screen">è»Šå…§è¢å¹•</option>
                                <option value="mobile_app">æ‰‹æ©Ÿ App</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">ç¾¤çµ„æ¨™ç±¤</label>
                            <input type="text" id="newDeviceGroups" class="form-control" 
                                   placeholder="è¼¸å…¥æ¨™ç±¤ï¼Œç”¨é€—è™Ÿåˆ†éš”" value="general">
                            <small style="color: #7f8c8d;">ä¾‹å¦‚: general, premium, taipei</small>
                        </div>
                        <button type="submit" class="btn btn-success">è¨»å†Šè¨­å‚™</button>
                    </form>
                </div>

                <div class="card">
                    <div class="card-title">
                        å·²è¨»å†Šè¨­å‚™åˆ—è¡¨
                        <button class="btn btn-primary btn-small" style="float: right;" onclick="loadRegisteredDevices()">
                            ğŸ”„ åˆ·æ–°
                        </button>
                    </div>
                    <div id="registeredDevicesList">
                        <div class="loader"></div>
                    </div>
                </div>

                <div class="card" style="background: #e8f5e9;">
                    <div class="card-title">ğŸ“± é€£æ¥èªªæ˜</div>
                    <ol style="line-height: 1.8;">
                        <li>åœ¨ä¸Šæ–¹è¡¨å–®ä¸­å¡«å¯«è¨­å‚™è³‡è¨Šä¸¦é»æ“Šã€Œè¨»å†Šè¨­å‚™ã€</li>
                        <li>è¨˜ä¸‹åˆ†é…çš„è¨­å‚™ IDï¼ˆä¾‹å¦‚: taxi-AAB-1234-rooftopï¼‰</li>
                        <li>åœ¨ App ç«¯ä½¿ç”¨ä»¥ä¸‹æ–¹å¼é€£æ¥ï¼š
                            <pre style="background: #fff; padding: 10px; margin-top: 10px; border-radius: 4px;">
python tests/test_location_client.py <è¨­å‚™ID> 5

ç¯„ä¾‹:
python tests/test_location_client.py taxi-AAB-1234-rooftop 5</pre>
                        </li>
                        <li>é€£æ¥æˆåŠŸå¾Œï¼Œè¨­å‚™æœƒè‡ªå‹•å‡ºç¾åœ¨ã€Œè¨­å‚™ç®¡ç†ã€é é¢</li>
                    </ol>
                </div>
            </div>

            <!-- è¨­å‚™ç®¡ç†é é¢ -->
            <div id="devicesPage" class="page-content">
                <h2>è¨­å‚™ç®¡ç†</h2>
                <div class="card">
                    <div class="card-title">
                        ç·šä¸Šè¨­å‚™
                        <button class="btn btn-primary" style="float: right;" onclick="refreshDevices()">
                            ğŸ”„ åˆ·æ–°
                        </button>
                    </div>
                    <div id="devicesList">
                        <div class="loader"></div>
                    </div>
                </div>
            </div>

            <!-- å»£å‘Šç®¡ç†é é¢ -->
            <div id="adsPage" class="page-content">
                <h2>å»£å‘Šç®¡ç†</h2>
                <div class="card">
                    <div class="card-title">
                        å»£å‘Šåˆ—è¡¨
                        <button class="btn btn-success" style="float: right;" onclick="showCreateAdModal()">
                            â• æ–°å¢å»£å‘Š
                        </button>
                    </div>
                    <div id="adsList">
                        <div class="loader"></div>
                    </div>
                </div>
            </div>

            <!-- å½±ç‰‡ä¸Šå‚³é é¢ -->
            <div id="uploadPage" class="page-content">
                <h2>å½±ç‰‡ä¸Šå‚³</h2>
                <div class="card">
                    <div class="card-title">åˆ†ç‰‡ä¸Šå‚³å½±ç‰‡</div>
                    <form id="uploadForm">
                        <div class="form-group">
                            <label class="form-label">é¸æ“‡å½±ç‰‡æ–‡ä»¶</label>
                            <input type="file" id="videoFile" class="form-control" accept="video/*" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">å»£å‘Šåç¨±</label>
                            <input type="text" id="adName" class="form-control" placeholder="è¼¸å…¥å»£å‘Šåç¨±" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">å»£å‘ŠIDï¼ˆé¸å¡«ï¼‰</label>
                            <input type="text" id="adId" class="form-control" placeholder="è‡ªå‹•ç”Ÿæˆ">
                        </div>
                        <button type="submit" class="btn btn-primary">é–‹å§‹ä¸Šå‚³</button>
                    </form>
                    <div id="uploadProgress" style="display: none; margin-top: 1rem;">
                        <div class="progress">
                            <div class="progress-bar" id="progressBar" style="width: 0%"></div>
                        </div>
                        <p id="progressText">æº–å‚™ä¸Šå‚³...</p>
                    </div>
                </div>
            </div>

            <!-- æ´»å‹•ç®¡ç†é é¢ -->
            <div id="campaignsPage" class="page-content">
                <h2>æ´»å‹•ç®¡ç†</h2>
                <div class="card">
                    <div class="card-title">æ´»å‹•åˆ—è¡¨</div>
                    <div id="campaignsList">
                        <div class="loader"></div>
                    </div>
                </div>
            </div>

            <!-- æ¨é€æ§åˆ¶é é¢ -->
            <div id="pushPage" class="page-content">
                <h2>æ¨é€æ§åˆ¶</h2>
                <div class="card">
                    <div class="card-title">å³æ™‚æ¨é€å»£å‘Š</div>
                    <form id="pushForm">
                        <div class="form-group">
                            <label class="form-label">é¸æ“‡ç›®æ¨™è¨­å‚™</label>
                            <div id="deviceSelector">
                                <p>è¼‰å…¥è¨­å‚™ä¸­...</p>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">é¸æ“‡å»£å‘Š</label>
                            <select id="adSelector" class="form-control">
                                <option value="">é¸æ“‡å»£å‘Š...</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary">ç«‹å³æ¨é€</button>
                    </form>
                </div>
            </div>

            <!-- ä¸‹è¼‰ç®¡ç†é é¢ -->
            <div id="downloadPage" class="page-content">
                <h2>ä¸‹è¼‰ç®¡ç†</h2>
                <div class="card">
                    <div class="card-title">æ¨é€å½±ç‰‡ä¸‹è¼‰</div>
                    <form id="downloadForm">
                        <div class="form-group">
                            <label class="form-label">é¸æ“‡ç›®æ¨™è¨­å‚™</label>
                            <div id="downloadDeviceSelector">
                                <p>è¼‰å…¥è¨­å‚™ä¸­...</p>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">é¸æ“‡è¦ä¸‹è¼‰çš„å»£å‘Š</label>
                            <select id="downloadAdSelector" class="form-control">
                                <option value="">é¸æ“‡å»£å‘Š...</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary">æ¨é€ä¸‹è¼‰</button>
                    </form>
                </div>
            </div>

            <!-- ç³»çµ±æ—¥èªŒé é¢ -->
            <div id="logsPage" class="page-content">
                <h2>ç³»çµ±æ—¥èªŒ</h2>
                <div class="card">
                    <div class="card-title">
                        å¯¦æ™‚æ—¥èªŒ
                        <button class="btn btn-danger btn-small" style="float: right;" onclick="clearLogs()">
                            æ¸…ç©ºæ—¥èªŒ
                        </button>
                    </div>
                    <div class="log-container" id="logContainer">
                        <div class="log-entry">
                            <span class="log-time">[ç³»çµ±å•Ÿå‹•]</span> ç®¡ç†ç³»çµ±å·²å•Ÿå‹•
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- å‰µå»ºå»£å‘Šå½ˆçª— -->
    <div id="createAdModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('createAdModal')">&times;</span>
            <h3>å‰µå»ºæ–°å»£å‘Š</h3>
            <form id="createAdForm">
                <div class="form-group">
                    <label class="form-label">å»£å‘ŠID</label>
                    <input type="text" id="newAdId" class="form-control" placeholder="è‡ªå‹•ç”Ÿæˆ">
                </div>
                <div class="form-group">
                    <label class="form-label">å»£å‘Šåç¨±</label>
                    <input type="text" id="newAdName" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label">é¡å‹</label>
                    <select id="newAdType" class="form-control">
                        <option value="general">ä¸€èˆ¬å»£å‘Š</option>
                        <option value="promotion">ä¿ƒéŠ·å»£å‘Š</option>
                        <option value="event">æ´»å‹•å»£å‘Š</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">å„ªå…ˆç´š</label>
                    <input type="number" id="newAdPriority" class="form-control" min="1" max="10" value="5">
                </div>
                <button type="submit" class="btn btn-success">å‰µå»ºå»£å‘Š</button>
            </form>
        </div>
    </div>

    <!-- Socket.IO å®¢æˆ¶ç«¯åº« -->
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    
    <script>

        // Socket.IO é€£æ¥
        let socket = null;
        // API åŸºç¤è·¯å¾‘
        // è‡ªå‹•åµæ¸¬ç›®å‰ç¶²åŸŸèˆ‡å”å®š
        const API_BASE = window.location.origin + '/api/v1/admin';
        // æ›´ç©©å®šç‰ˆæœ¬ï¼ˆAzure App Service å°ˆç”¨ï¼‰
        const SOCKETIO_URL = window.location.origin;

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initWebSocket();
            loadDashboard();
            setupEventListeners();
        });

        // socket = io(SOCKETIO_URL, {
        //     transports: ['websocket'],  // ä¿ç•™ç´” websocket
        //     reconnection: true,
        //     reconnectionDelay: 5000,
        //     reconnectionAttempts: Infinity
        // });


        // ç•¶å‰é é¢
        let currentPage = 'dashboard';
        

        
        // åˆå§‹åŒ– WebSocket (ä½¿ç”¨ Socket.IO)
        function initWebSocket() {
            try {
                // å¦‚æœå·²ç¶“æœ‰é€£æ¥ï¼Œå…ˆæ–·é–‹
                if (socket) {
                    socket.disconnect();
                }
                
                // å»ºç«‹ Socket.IO é€£æ¥
                socket = io(SOCKETIO_URL, {
                    transports: ['websocket'],
                    reconnection: true,
                    reconnectionDelay: 5000,
                    reconnectionAttempts: Infinity
                });
                
                socket.on('connect', function() {
                    addLog('Socket.IO é€£æ¥å·²å»ºç«‹ (SID: ' + socket.id + ')', 'info');
                });
                
                socket.on('disconnect', function() {
                    addLog('Socket.IO é€£æ¥å·²æ–·é–‹', 'warning');
                });
                
                socket.on('connect_error', function(error) {
                    addLog('Socket.IO é€£æ¥éŒ¯èª¤: ' + error.message, 'error');
                });
                
                socket.on('connection_established', function(data) {
                    addLog('æœå‹™å™¨ç¢ºèªé€£æ¥: ' + data.message, 'info');
                });
                
                // ç›£è½è¨­å‚™é€£æ¥/æ–·é–‹äº‹ä»¶
                socket.on('device_status', function(data) {
                    handleWebSocketMessage(data);
                });
                
            } catch (error) {
                addLog('åˆå§‹åŒ– Socket.IO å¤±æ•—: ' + error.message, 'error');
            }
        }
        
        // è™•ç† WebSocket æ¶ˆæ¯
        function handleWebSocketMessage(data) {
            switch(data.type) {
                case 'device_connected':
                    addLog(`è¨­å‚™ ${data.device_id} å·²é€£æ¥`, 'info');
                    if (currentPage === 'dashboard' || currentPage === 'devices') {
                        loadDashboard();
                    }
                    break;
                case 'device_disconnected':
                    addLog(`è¨­å‚™ ${data.device_id} å·²æ–·é–‹`, 'warning');
                    if (currentPage === 'dashboard' || currentPage === 'devices') {
                        loadDashboard();
                    }
                    break;
            }
        }
        
        // é¡¯ç¤ºé é¢
        function showPage(pageName,event) {
            // éš±è—æ‰€æœ‰é é¢
            document.querySelectorAll('.page-content').forEach(page => {
                page.classList.remove('active');
            });
            
            // æ›´æ–°å´é‚Šæ¬„
            document.querySelectorAll('.sidebar-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // é¡¯ç¤ºé¸ä¸­é é¢
            document.getElementById(pageName + 'Page').classList.add('active');
            event.target.classList.add('active');
            
            currentPage = pageName;
            
            // è¼‰å…¥é é¢æ•¸æ“š
            switch(pageName) {
                case 'dashboard':
                    loadDashboard();
                    break;
                case 'register':
                    loadRegisteredDevices();
                    break;
                case 'devices':
                    loadDevices();
                    break;
                case 'ads':
                    loadAds();
                    break;
                case 'campaigns':
                    loadCampaigns();
                    break;
                case 'push':
                    loadPushPage();
                    break;
                case 'download':
                    loadDownloadPage();
                    break;
            }
        }
        
        // è¨»å†Šæ–°è¨­å‚™
        async function registerDevice() {
            const deviceId = document.getElementById('newDeviceId').value.trim();
            const deviceType = document.getElementById('newDeviceType').value;
            const groupsInput = document.getElementById('newDeviceGroups').value;
            
            // è§£æç¾¤çµ„æ¨™ç±¤
            const groups = groupsInput.split(',').map(g => g.trim()).filter(g => g);
            
            if (!deviceId) {
                alert('è«‹è¼¸å…¥è¨­å‚™ ID');
                return;
            }
            
            try {
                const response = await fetch(API_BASE + '/devices', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        device_id: deviceId,
                        device_type: deviceType,
                        groups: groups.length > 0 ? groups : ['general']
                    })
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    addLog(`è¨­å‚™è¨»å†ŠæˆåŠŸ: ${deviceId}`, 'success');
                    alert(`âœ… è¨­å‚™è¨»å†ŠæˆåŠŸï¼\n\nè¨­å‚™ ID: ${deviceId}\n\nè«‹ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤é€£æ¥ï¼š\npython tests/test_location_client.py ${deviceId} 5`);
                    
                    // é‡ç½®è¡¨å–®
                    document.getElementById('registerDeviceForm').reset();
                    document.getElementById('newDeviceGroups').value = 'general';
                    
                    // åˆ·æ–°è¨­å‚™åˆ—è¡¨
                    loadRegisteredDevices();
                } else {
                    throw new Error(data.message || 'è¨»å†Šå¤±æ•—');
                }
            } catch (error) {
                addLog('è¨­å‚™è¨»å†Šå¤±æ•—: ' + error.message, 'error');
                alert('è¨­å‚™è¨»å†Šå¤±æ•—: ' + error.message);
            }
        }
        
        // è¼‰å…¥å·²è¨»å†Šè¨­å‚™åˆ—è¡¨
        async function loadRegisteredDevices() {
            try {
                const response = await fetch(API_BASE + '/devices');
                const data = await response.json();
                
                const devicesList = document.getElementById('registeredDevicesList');
                
                if (data.devices && data.devices.length > 0) {
                    devicesList.innerHTML = `
                        <table>
                            <thead>
                                <tr>
                                    <th>è¨­å‚™ ID</th>
                                    <th>è¨­å‚™é¡å‹</th>
                                    <th>ç¾¤çµ„</th>
                                    <th>ç‹€æ…‹</th>
                                    <th>è¨»å†Šæ™‚é–“</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.devices.map(device => `
                                    <tr>
                                        <td><strong>${device.device_id}</strong></td>
                                        <td>${getDeviceTypeLabel(device.device_type)}</td>
                                        <td>${device.groups ? device.groups.join(', ') : '-'}</td>
                                        <td>
                                            <span class="device-status ${device.is_online ? 'status-online' : 'status-offline'}">
                                                ${device.is_online ? 'ç·šä¸Š' : 'é›¢ç·š'}
                                            </span>
                                        </td>
                                        <td>${device.created_at ? new Date(device.created_at).toLocaleString('zh-TW') : '-'}</td>
                                        <td>
                                            <button class="btn btn-primary btn-small" onclick="copyDeviceId('${device.device_id}')">
                                                è¤‡è£½ ID
                                            </button>
                                            <button class="btn btn-danger btn-small" onclick="deleteDevice('${device.device_id}')">
                                                åˆªé™¤
                                            </button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                } else {
                    devicesList.innerHTML = '<p>ç›®å‰æ²’æœ‰å·²è¨»å†Šçš„è¨­å‚™</p>';
                }
            } catch (error) {
                addLog('è¼‰å…¥è¨­å‚™åˆ—è¡¨å¤±æ•—: ' + error.message, 'error');
                document.getElementById('registeredDevicesList').innerHTML = '<p>è¼‰å…¥å¤±æ•—</p>';
            }
        }
        
        // è¤‡è£½è¨­å‚™ ID åˆ°å‰ªè²¼ç°¿
        async function copyDeviceId(deviceId) {
            try {
                await navigator.clipboard.writeText(deviceId);
                alert('âœ… è¨­å‚™ ID å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼\n\n' + deviceId);
            } catch (err) {
                // é™ç´šæ–¹æ¡ˆ
                const textArea = document.createElement('textarea');
                textArea.value = deviceId;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('âœ… è¨­å‚™ ID å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼\n\n' + deviceId);
            }
        }
        
        // åˆªé™¤è¨­å‚™
        async function deleteDevice(deviceId) {
            if (!confirm(`ç¢ºå®šè¦åˆªé™¤è¨­å‚™ ${deviceId} å—ï¼Ÿ`)) {
                return;
            }
            
            try {
                const response = await fetch(API_BASE + `/devices/${deviceId}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                if (data.status === 'success') {
                    addLog(`è¨­å‚™å·²åˆªé™¤: ${deviceId}`, 'info');
                    loadRegisteredDevices();
                } else {
                    throw new Error(data.message);
                }
            } catch (error) {
                addLog('åˆªé™¤è¨­å‚™å¤±æ•—: ' + error.message, 'error');
                alert('åˆªé™¤å¤±æ•—: ' + error.message);
            }
        }
        
        // ç²å–è¨­å‚™é¡å‹æ¨™ç±¤
        function getDeviceTypeLabel(type) {
            const labels = {
                'rooftop_display': 'è»Šé ‚é¡¯ç¤ºå™¨',
                'in_car_screen': 'è»Šå…§è¢å¹•',
                'mobile_app': 'æ‰‹æ©Ÿ App'
            };
            return labels[type] || type;
        }
        
        // è¼‰å…¥å„€è¡¨æ¿
        async function loadDashboard() {
            try {
                // ç²å–çµ±è¨ˆæ•¸æ“š
                const [connectionsRes, adsRes, campaignsRes, healthRes] = await Promise.all([
                    fetch(API_BASE + '/connections'),
                    fetch(API_BASE + '/advertisements?status=active'),
                    fetch(API_BASE + '/campaigns?status=active'),
                    fetch(window.location.origin + '/health')
                ]);
                
                const connections = await connectionsRes.json();
                const ads = await adsRes.json();
                const campaigns = await campaignsRes.json();
                const health = await healthRes.json();
                
                // æ›´æ–°çµ±è¨ˆ
                document.getElementById('activeDevices').textContent = connections.active_devices?.length || 0;
                document.getElementById('totalAds').textContent = ads.total || 0;
                document.getElementById('activeCampaigns').textContent = campaigns.total || 0;
                document.getElementById('todayPushes').textContent = connections.stats?.messages_sent || 0;
                
                // æ›´æ–°ç³»çµ±ç‹€æ…‹
                document.getElementById('systemStatus').innerHTML = `
                    <p>æœå‹™ç‹€æ…‹: <span style="color: #27ae60;">é‹è¡Œä¸­</span></p>
                    <p>æ•¸æ“šåº«ç‹€æ…‹: ${health.database}</p>
                    <p>æ´»å‹•é€£æ¥æ•¸: ${health.active_connections}</p>
                    <p>æœå‹™å™¨æ™‚é–“: ${new Date().toLocaleString('zh-TW')}</p>
                `;
            } catch (error) {
                addLog('è¼‰å…¥å„€è¡¨æ¿å¤±æ•—: ' + error.message, 'error');
            }
        }
        
        // è¼‰å…¥è¨­å‚™åˆ—è¡¨
        async function loadDevices() {
            try {
                const response = await fetch(API_BASE + '/connections');
                const data = await response.json();
                
                const devicesList = document.getElementById('devicesList');
                
                if (data.active_devices && data.active_devices.length > 0) {
                    devicesList.innerHTML = data.active_devices.map(device => `
                        <div class="device-card">
                            <div class="device-info">
                                <h4>${device.device_id}</h4>
                                <p>é€£æ¥æ™‚é–“: ${new Date(device.connected_at).toLocaleString('zh-TW')}</p>
                                <p>æœ€å¾Œæ´»å‹•: ${new Date(device.last_activity).toLocaleString('zh-TW')}</p>
                            </div>
                            <div>
                                <span class="device-status status-online">ç·šä¸Š</span>
                                <button class="btn btn-primary btn-small" onclick="pushToDevice('${device.device_id}')">
                                    æ¨é€
                                </button>
                            </div>
                        </div>
                    `).join('');
                } else {
                    devicesList.innerHTML = '<p>ç›®å‰æ²’æœ‰ç·šä¸Šè¨­å‚™</p>';
                }
            } catch (error) {
                addLog('è¼‰å…¥è¨­å‚™åˆ—è¡¨å¤±æ•—: ' + error.message, 'error');
            }
        }
        
        // è¼‰å…¥å»£å‘Šåˆ—è¡¨
        async function loadAds() {
            try {
                const response = await fetch(API_BASE + '/advertisements?status=active');
                const data = await response.json();
                
                const adsList = document.getElementById('adsList');
                
                if (data.advertisements && data.advertisements.length > 0) {
                    adsList.innerHTML = `
                        <table>
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>åç¨±</th>
                                    <th>æ–‡ä»¶å</th>
                                    <th>å¤§å°</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.advertisements.map(ad => `
                                    <tr>
                                        <td>${ad.advertisement_id}</td>
                                        <td>${ad.name}</td>
                                        <td>${ad.video_filename || '-'}</td>
                                        <td>${ad.file_size ? formatFileSize(ad.file_size) : '-'}</td>
                                        <td>
                                            <button class="btn btn-danger btn-small" onclick="deleteAd('${ad.advertisement_id}')">
                                                åˆªé™¤
                                            </button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                } else {
                    adsList.innerHTML = '<p>ç›®å‰æ²’æœ‰å»£å‘Š</p>';
                }
            } catch (error) {
                addLog('è¼‰å…¥å»£å‘Šåˆ—è¡¨å¤±æ•—: ' + error.message, 'error');
            }
        }
        
        // è¼‰å…¥æ´»å‹•åˆ—è¡¨
        async function loadCampaigns() {
            try {
                const response = await fetch(API_BASE + '/campaigns?status=active');
                const data = await response.json();
                
                const campaignsList = document.getElementById('campaignsList');
                
                if (data.campaigns && data.campaigns.length > 0) {
                    campaignsList.innerHTML = `
                        <table>
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>åç¨±</th>
                                    <th>å»£å‘Š</th>
                                    <th>å„ªå…ˆç´š</th>
                                    <th>ç›®æ¨™ç¾¤çµ„</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.campaigns.map(campaign => `
                                    <tr>
                                        <td>${campaign.campaign_id}</td>
                                        <td>${campaign.name}</td>
                                        <td>${campaign.advertisement_name || campaign.advertisement_id}</td>
                                        <td>${campaign.priority}</td>
                                        <td>${campaign.target_groups.join(', ')}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                } else {
                    campaignsList.innerHTML = '<p>ç›®å‰æ²’æœ‰æ´»å‹•</p>';
                }
            } catch (error) {
                addLog('è¼‰å…¥æ´»å‹•åˆ—è¡¨å¤±æ•—: ' + error.message, 'error');
            }
        }
        
        // è¼‰å…¥æ¨é€é é¢
        async function loadPushPage() {
            try {
                // è¼‰å…¥è¨­å‚™åˆ—è¡¨
                const devicesRes = await fetch(API_BASE + '/connections');
                const devicesData = await devicesRes.json();
                
                const deviceSelector = document.getElementById('deviceSelector');
                if (devicesData.active_devices && devicesData.active_devices.length > 0) {
                    deviceSelector.innerHTML = devicesData.active_devices.map(device => `
                        <label>
                            <input type="checkbox" name="devices" value="${device.device_id}">
                            ${device.device_id}
                        </label><br>
                    `).join('');
                } else {
                    deviceSelector.innerHTML = '<p>æ²’æœ‰ç·šä¸Šè¨­å‚™</p>';
                }
                
                // è¼‰å…¥å»£å‘Šåˆ—è¡¨
                const adsRes = await fetch(API_BASE + '/advertisements?status=active');
                const adsData = await adsRes.json();
                
                const adSelector = document.getElementById('adSelector');
                adSelector.innerHTML = '<option value="">é¸æ“‡å»£å‘Š...</option>' +
                    adsData.advertisements.map(ad => 
                        `<option value="${ad.advertisement_id}">${ad.name} (${ad.video_filename})</option>`
                    ).join('');
            } catch (error) {
                addLog('è¼‰å…¥æ¨é€é é¢å¤±æ•—: ' + error.message, 'error');
            }
        }
        
        // è¼‰å…¥ä¸‹è¼‰é é¢
        async function loadDownloadPage() {
            try {
                // è¼‰å…¥è¨­å‚™åˆ—è¡¨
                const devicesRes = await fetch(API_BASE + '/connections');
                const devicesData = await devicesRes.json();
                
                const deviceSelector = document.getElementById('downloadDeviceSelector');
                if (devicesData.active_devices && devicesData.active_devices.length > 0) {
                    deviceSelector.innerHTML = devicesData.active_devices.map(device => `
                        <label>
                            <input type="checkbox" name="downloadDevices" value="${device.device_id}">
                            ${device.device_id}
                        </label><br>
                    `).join('');
                } else {
                    deviceSelector.innerHTML = '<p>æ²’æœ‰ç·šä¸Šè¨­å‚™</p>';
                }
                
                // è¼‰å…¥æœ‰å½±ç‰‡çš„å»£å‘Šåˆ—è¡¨
                const adsRes = await fetch(API_BASE + '/advertisements/available?with_files=true');
                const adsData = await adsRes.json();
                
                const adSelector = document.getElementById('downloadAdSelector');
                adSelector.innerHTML = '<option value="">é¸æ“‡å»£å‘Š...</option>' +
                    adsData.advertisements.map(ad => 
                        `<option value="${ad.advertisement_id}">${ad.name} (${formatFileSize(ad.file_size)})</option>`
                    ).join('');
            } catch (error) {
                addLog('è¼‰å…¥ä¸‹è¼‰é é¢å¤±æ•—: ' + error.message, 'error');
            }
        }
        
        // è¨­ç½®äº‹ä»¶ç›£è½å™¨
        function setupEventListeners() {
            // è¨­å‚™è¨»å†Šè¡¨å–®
            document.getElementById('registerDeviceForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                await registerDevice();
            });
            
            // ä¸Šå‚³è¡¨å–®
            document.getElementById('uploadForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                await uploadVideo();
            });
            
            // æ¨é€è¡¨å–®
            document.getElementById('pushForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                await pushAdvertisement();
            });
            
            // ä¸‹è¼‰è¡¨å–®
            document.getElementById('downloadForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                await pushDownload();
            });
            
            // å‰µå»ºå»£å‘Šè¡¨å–®
            document.getElementById('createAdForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                await createAdvertisement();
            });
        }
        
        // åˆ†ç‰‡ä¸Šå‚³å½±ç‰‡
        async function uploadVideo() {
            const fileInput = document.getElementById('videoFile');
            const file = fileInput.files[0];
            const adName = document.getElementById('adName').value;
            const adId = document.getElementById('adId').value;
            
            if (!file || !adName) {
                alert('è«‹é¸æ“‡æ–‡ä»¶ä¸¦è¼¸å…¥å»£å‘Šåç¨±');
                return;
            }
            
            const chunkSize = 10 * 1024 * 1024; // 10MB
            const totalChunks = Math.ceil(file.size / chunkSize);
            
            document.getElementById('uploadProgress').style.display = 'block';
            
            try {
                // 1. åˆå§‹åŒ–åˆ†ç‰‡ä¸Šå‚³
                const initRes = await fetch(API_BASE + '/videos/chunked/init', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        filename: file.name,
                        total_size: file.size,
                        total_chunks: totalChunks,
                        name: adName,
                        advertisement_id: adId || undefined
                    })
                });
                
                const initData = await initRes.json();
                if (initData.status !== 'success') {
                    throw new Error(initData.message);
                }
                
                const uploadId = initData.upload_id;
                
                // 2. ä¸Šå‚³åˆ†ç‰‡
                for (let i = 0; i < totalChunks; i++) {
                    const start = i * chunkSize;
                    const end = Math.min(start + chunkSize, file.size);
                    const chunk = file.slice(start, end);
                    
                    const formData = new FormData();
                    formData.append('upload_id', uploadId);
                    formData.append('chunk_number', i.toString());
                    formData.append('chunk', chunk);
                    
                    const chunkRes = await fetch(API_BASE + '/videos/chunked/upload', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const chunkData = await chunkRes.json();
                    if (chunkData.status !== 'success') {
                        throw new Error(chunkData.message);
                    }
                    
                    const progress = ((i + 1) / totalChunks) * 100;
                    updateProgress(progress, `ä¸Šå‚³ä¸­... ${i + 1}/${totalChunks}`);
                }
                
                // 3. å®Œæˆä¸Šå‚³
                const completeRes = await fetch(API_BASE + '/videos/chunked/complete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ upload_id: uploadId })
                });
                
                const completeData = await completeRes.json();
                if (completeData.status !== 'success') {
                    throw new Error(completeData.message);
                }
                
                addLog(`å½±ç‰‡ä¸Šå‚³æˆåŠŸ: ${completeData.video_info.filename}`, 'success');
                alert('å½±ç‰‡ä¸Šå‚³æˆåŠŸï¼');
                
                // é‡ç½®è¡¨å–®
                document.getElementById('uploadForm').reset();
                document.getElementById('uploadProgress').style.display = 'none';
                
            } catch (error) {
                addLog('å½±ç‰‡ä¸Šå‚³å¤±æ•—: ' + error.message, 'error');
                alert('ä¸Šå‚³å¤±æ•—: ' + error.message);
            }
        }
        
        // æ¨é€å»£å‘Š
        async function pushAdvertisement() {
            const selectedDevices = Array.from(document.querySelectorAll('input[name="devices"]:checked'))
                .map(cb => cb.value);
            const adId = document.getElementById('adSelector').value;
            
            if (selectedDevices.length === 0 || !adId) {
                alert('è«‹é¸æ“‡è¨­å‚™å’Œå»£å‘Š');
                return;
            }
            
            try {
                const response = await fetch(API_BASE + '/override', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        target_device_ids: selectedDevices,
                        advertisement_id: adId
                    })
                });
                
                const data = await response.json();
                if (data.status === 'success') {
                    addLog(`æ¨é€æˆåŠŸ: ${data.results.sent.length} å€‹è¨­å‚™`, 'success');
                    alert('æ¨é€æˆåŠŸï¼');
                } else {
                    throw new Error(data.message);
                }
            } catch (error) {
                addLog('æ¨é€å¤±æ•—: ' + error.message, 'error');
                alert('æ¨é€å¤±æ•—: ' + error.message);
            }
        }
        
        // æ¨é€ä¸‹è¼‰
        async function pushDownload() {
            const selectedDevices = Array.from(document.querySelectorAll('input[name="downloadDevices"]:checked'))
                .map(cb => cb.value);
            const adId = document.getElementById('downloadAdSelector').value;
            
            if (selectedDevices.length === 0 || !adId) {
                alert('è«‹é¸æ“‡è¨­å‚™å’Œå»£å‘Š');
                return;
            }
            
            try {
                const response = await fetch(API_BASE + '/push/download', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        target_device_ids: selectedDevices,
                        advertisement_id: adId,
                        priority: 'normal',
                        download_mode: 'chunked'
                    })
                });
                
                const data = await response.json();
                if (data.status === 'success') {
                    addLog(`ä¸‹è¼‰æ¨é€æˆåŠŸ: ${data.results.sent.length} å€‹è¨­å‚™`, 'success');
                    alert('ä¸‹è¼‰æ¨é€æˆåŠŸï¼');
                } else {
                    throw new Error(data.message);
                }
            } catch (error) {
                addLog('ä¸‹è¼‰æ¨é€å¤±æ•—: ' + error.message, 'error');
                alert('ä¸‹è¼‰æ¨é€å¤±æ•—: ' + error.message);
            }
        }
        
        // å‰µå»ºå»£å‘Š
        async function createAdvertisement() {
            const adId = document.getElementById('newAdId').value;
            const adName = document.getElementById('newAdName').value;
            const adType = document.getElementById('newAdType').value;
            const adPriority = document.getElementById('newAdPriority').value;
            
            try {
                const response = await fetch(API_BASE + '/advertisements', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        advertisement_id: adId || undefined,
                        name: adName,
                        type: adType,
                        priority: parseInt(adPriority),
                        target_groups: ['general']
                    })
                });
                
                const data = await response.json();
                if (data.status === 'success') {
                    addLog(`å»£å‘Šå‰µå»ºæˆåŠŸ: ${data.advertisement_id}`, 'success');
                    alert('å»£å‘Šå‰µå»ºæˆåŠŸï¼');
                    closeModal('createAdModal');
                    loadAds();
                } else {
                    throw new Error(data.message);
                }
            } catch (error) {
                addLog('å‰µå»ºå»£å‘Šå¤±æ•—: ' + error.message, 'error');
                alert('å‰µå»ºå¤±æ•—: ' + error.message);
            }
        }
        
        // åˆªé™¤å»£å‘Š
        async function deleteAd(adId) {
            if (!confirm(`ç¢ºå®šè¦åˆªé™¤å»£å‘Š ${adId} å—ï¼Ÿ`)) {
                return;
            }
            
            try {
                const response = await fetch(API_BASE + `/advertisements/${adId}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                if (data.status === 'success') {
                    addLog(`å»£å‘Šå·²åˆªé™¤: ${adId}`, 'info');
                    loadAds();
                } else {
                    throw new Error(data.message);
                }
            } catch (error) {
                addLog('åˆªé™¤å»£å‘Šå¤±æ•—: ' + error.message, 'error');
                alert('åˆªé™¤å¤±æ•—: ' + error.message);
            }
        }
        
        // åˆ·æ–°è¨­å‚™åˆ—è¡¨
        function refreshDevices() {
            loadDevices();
            addLog('è¨­å‚™åˆ—è¡¨å·²åˆ·æ–°', 'info');
        }
        
        // æ¨é€åˆ°å–®å€‹è¨­å‚™
        async function pushToDevice(deviceId) {
            const adId = prompt('è«‹è¼¸å…¥è¦æ¨é€çš„å»£å‘ŠID:');
            if (!adId) return;
            
            try {
                const response = await fetch(API_BASE + '/override', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        target_device_ids: [deviceId],
                        advertisement_id: adId
                    })
                });
                
                const data = await response.json();
                if (data.status === 'success') {
                    addLog(`æ¨é€æˆåŠŸåˆ°è¨­å‚™: ${deviceId}`, 'success');
                    alert('æ¨é€æˆåŠŸï¼');
                } else {
                    throw new Error(data.message);
                }
            } catch (error) {
                addLog('æ¨é€å¤±æ•—: ' + error.message, 'error');
                alert('æ¨é€å¤±æ•—: ' + error.message);
            }
        }
        
        // æ›´æ–°é€²åº¦æ¢
        function updateProgress(percent, text) {
            document.getElementById('progressBar').style.width = percent + '%';
            document.getElementById('progressText').textContent = text;
        }
        
        // æ·»åŠ æ—¥èªŒ
        function addLog(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const time = new Date().toLocaleTimeString('zh-TW');
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.innerHTML = `<span class="log-time">[${time}]</span> ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }
        
        // æ¸…ç©ºæ—¥èªŒ
        function clearLogs() {
            const logContainer = document.getElementById('logContainer');
            logContainer.innerHTML = '<div class="log-entry"><span class="log-time">[ç³»çµ±]</span> æ—¥èªŒå·²æ¸…ç©º</div>';
        }
        
        // é¡¯ç¤ºå½ˆçª—
        function showCreateAdModal() {
            document.getElementById('createAdModal').style.display = 'block';
        }
        
        // é—œé–‰å½ˆçª—
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        
        // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // é»æ“Šå½ˆçª—å¤–éƒ¨é—œé–‰
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }
    </script>
</body>
</html>
